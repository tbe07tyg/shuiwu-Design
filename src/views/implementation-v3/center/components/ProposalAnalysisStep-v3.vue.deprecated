<!--
 * @file ç¬¬äºŒæ­¥ï¼šç”³æŠ¥ä¹¦å†…å®¹è§£ææ­¥éª¤ç»„ä»¶ v3.0
 * @description åŸºäºè±†åŒ…AIçš„æ™ºèƒ½ç”³æŠ¥ä¹¦è§£æå’Œä»»åŠ¡æå–ï¼Œæ”¯æŒPDFé¢„è§ˆå’Œåˆ†åŒºåŸŸå±•ç¤º
 * @author ç§‘ç ”ç®¡ç†ç³»ç»Ÿ
 * @version 3.0.0
 * @date 2025-01-29
-->
<template>
  <div class="proposal-analysis-step-v3">
    <!-- æ­¥éª¤è¯´æ˜ -->
    <div class="step-description">
      <h3>ç¬¬äºŒæ­¥ï¼šç”³æŠ¥ä¹¦å†…å®¹è§£æ - æ™ºèƒ½ä»»åŠ¡æ‹†è§£ç‰ˆæœ¬</h3>
      <p>ç³»ç»Ÿè‡ªåŠ¨è·å–ç«‹é¡¹ç”³æŠ¥ä¹¦å¹¶è½¬æ¢ä¸ºPDFé¢„è§ˆï¼Œä½¿ç”¨è±†åŒ…AIæ™ºèƒ½è§£æç”³æŠ¥ä¹¦å†…å®¹ï¼ŒæŒ‰æ¨¡æ¿ç»“æ„åˆ†åŒºåŸŸå±•ç¤ºè§£æç»“æœï¼Œé‡ç‚¹è¯†åˆ«é€‚åˆé¡¹ç›®ä»»åŠ¡æ‹†è§£çš„å†…å®¹æ¿å—ã€‚</p>
      
      <a-alert
        message="æ™ºèƒ½è§£æè¯´æ˜"
        type="info"
        show-icon
        style="margin-top: 12px;"
      >
        <template #description>
          <div class="analysis-guide">
            <p><strong>ğŸ¯ ä»»åŠ¡æ‹†è§£é‡ç‚¹åŒºåŸŸï¼š</strong></p>
            <ul>
              <li><strong>å®æ–½æ–¹æ¡ˆ</strong>ï¼šè¯†åˆ«ä¸»è¦å·¥ä½œåŒ…å’Œå…·ä½“ä»»åŠ¡</li>
              <li><strong>æŠ€æœ¯è·¯çº¿</strong>ï¼šæ¢³ç†æŠ€æœ¯ä»»åŠ¡å’Œä¾èµ–å…³ç³»</li>
              <li><strong>è¿›åº¦è®¡åˆ’</strong>ï¼šæå–æ—¶é—´èŠ‚ç‚¹å’Œé‡Œç¨‹ç¢‘</li>
              <li><strong>æŠ€æœ¯å…³é”®</strong>ï¼šè¯†åˆ«æŠ€æœ¯æ”»å…³ä»»åŠ¡</li>
            </ul>
          </div>
        </template>
      </a-alert>
    </div>

    <!-- ä¸»ä½“å†…å®¹åŒºåŸŸ -->
    <a-row :gutter="24" class="main-content">
      <!-- å·¦ä¾§ï¼šPDFé¢„è§ˆåŒºåŸŸ -->
      <a-col :span="10">
        <a-card title="ğŸ“„ ç”³æŠ¥ä¹¦PDFé¢„è§ˆ" class="pdf-preview-card">
          <template #extra>
            <a-space>
              <a-button size="small" @click="refreshPdf" :loading="pdfLoading">
                <ReloadOutlined />
                åˆ·æ–°
              </a-button>
              <a-button size="small" @click="downloadPdf">
                <DownloadOutlined />
                ä¸‹è½½
              </a-button>
            </a-space>
          </template>
          
          <!-- PDFé¢„è§ˆç»„ä»¶ -->
          <div class="pdf-viewer-container">
            <iframe
              v-if="pdfUrl && !pdfLoading"
              :src="pdfUrl"
              class="pdf-viewer"
              frameborder="0"
            ></iframe>
            
            <div v-else class="pdf-loading">
              <a-spin size="large" />
              <p>{{ pdfLoading ? 'æ­£åœ¨è½¬æ¢PDF...' : 'æš‚æ— PDFé¢„è§ˆ' }}</p>
            </div>
          </div>
          
          <!-- æ–‡æ¡£ä¿¡æ¯ -->
          <div class="document-info" v-if="documentInfo">
            <a-descriptions size="small" :column="1" bordered>
              <a-descriptions-item label="æ–‡ä»¶å">
                {{ documentInfo.filename }}
              </a-descriptions-item>
              <a-descriptions-item label="æ–‡ä»¶å¤§å°">
                {{ documentInfo.fileSize }}
              </a-descriptions-item>
              <a-descriptions-item label="é¡µæ•°">
                {{ documentInfo.pageCount }}
              </a-descriptions-item>
              <a-descriptions-item label="è§£æçŠ¶æ€">
                <a-tag :color="getParseStatusColor()">
                  {{ getParseStatusText() }}
                </a-tag>
              </a-descriptions-item>
            </a-descriptions>
          </div>
        </a-card>
      </a-col>
      
      <!-- å³ä¾§ï¼šè§£æç»“æœåˆ†åŒºå±•ç¤º -->
      <a-col :span="14">
        <a-card title="ğŸ¤– è§£æç»“æœåˆ†åŒºå±•ç¤º" class="analysis-results-card">
          <template #extra>
            <a-space>
              <a-button @click="showDoubaoGuide">
                <BulbOutlined />
                è±†åŒ…è§£ææŒ‡å—
              </a-button>
              <a-button type="primary" @click="showImportModal">
                <ImportOutlined />
                å¯¼å…¥è±†åŒ…ç»“æœ
              </a-button>
            </a-space>
          </template>
          
          <!-- è§£æç»“æœåˆ†åŒº -->
          <div class="analysis-sections">
            <!-- é¡¹ç›®æ¦‚å†µåŒºåŸŸ -->
            <AnalysisSection
              title="ğŸ“Š é¡¹ç›®æ¦‚å†µ"
              :data="analysisResults.projectOverview"
              :tasks="extractedTasks.projectOverview || []"
              :editable="true"
              :taskRelevant="false"
              @edit="handleEdit"
            />
            
            <!-- å®æ–½æ–¹æ¡ˆåŒºåŸŸ - é‡ç‚¹ä»»åŠ¡æ‹†è§£ -->
            <AnalysisSection
              title="ğŸ› ï¸ å®æ–½æ–¹æ¡ˆ"
              :data="analysisResults.implementationPlan"
              :tasks="extractedTasks.implementationTasks || []"
              :editable="true"
              :taskRelevant="true"
              :priority="'high'"
              @edit="handleEdit"
              @viewTasks="handleViewTasks"
            />
            
            <!-- æŠ€æœ¯è·¯çº¿åŒºåŸŸ - é‡ç‚¹ä»»åŠ¡æ‹†è§£ -->
            <AnalysisSection
              title="ğŸ”¬ æŠ€æœ¯è·¯çº¿"
              :data="analysisResults.technicalRoute"
              :tasks="extractedTasks.technicalTasks || []"
              :editable="true"
              :taskRelevant="true"
              :priority="'high'"
              @edit="handleEdit"
              @viewTasks="handleViewTasks"
            />
            
            <!-- è¿›åº¦è®¡åˆ’åŒºåŸŸ - é‡ç‚¹ä»»åŠ¡æ‹†è§£ -->
            <AnalysisSection
              title="ğŸ“… è¿›åº¦è®¡åˆ’"
              :data="analysisResults.schedule"
              :tasks="extractedTasks.milestoneTasks || []"
              :editable="true"
              :taskRelevant="true"
              :priority="'high'"
              @edit="handleEdit"
              @viewTasks="handleViewTasks"
            />
            
            <!-- æŠ€æœ¯å…³é”®åŒºåŸŸ -->
            <AnalysisSection
              title="ğŸ”‘ æŠ€æœ¯å…³é”®"
              :data="analysisResults.keyTechnologies"
              :tasks="extractedTasks.researchTasks || []"
              :editable="true"
              :taskRelevant="true"
              :priority="'medium'"
              @edit="handleEdit"
              @viewTasks="handleViewTasks"
            />
            
            <!-- å›¢é˜Ÿä¿¡æ¯åŒºåŸŸ -->
            <AnalysisSection
              title="ğŸ‘¥ å›¢é˜Ÿä¿¡æ¯"
              :data="analysisResults.teamInfo"
              :tasks="[]"
              :editable="true"
              :taskRelevant="false"
              @edit="handleEdit"
            />
            
            <!-- æ•ˆç›Šé¢„æœŸåŒºåŸŸ -->
            <AnalysisSection
              title="ğŸ“ˆ æ•ˆç›Šé¢„æœŸ"
              :data="analysisResults.expectedBenefits"
              :tasks="[]"
              :editable="true"
              :taskRelevant="false"
              @edit="handleEdit"
            />
          </div>
        </a-card>
      </a-col>
    </a-row>

    <!-- æ“ä½œåŒºåŸŸ -->
    <div class="operation-area">
      <a-card title="ğŸ¯ æ“ä½œåŒºåŸŸ" class="operation-card">
        <a-row :gutter="16">
          <!-- è±†åŒ…è§£æå·¥å…· -->
          <a-col :span="8">
            <div class="operation-section">
              <h4>ğŸ¤– è±†åŒ…è§£æ</h4>
              <a-space direction="vertical" style="width: 100%;">
                <a-button 
                  type="primary" 
                  block
                  @click="copyEnhancedPrompt"
                  :loading="copyingPrompt"
                >
                  <RobotOutlined />
                  å¤åˆ¶å¢å¼ºæç¤ºè¯ï¼ˆå«ä»»åŠ¡æå–ï¼‰
                </a-button>
                <a-button block @click="openDoubaoWebsite">
                  <LinkOutlined />
                  æ‰“å¼€è±†åŒ…ç½‘é¡µç‰ˆ
                </a-button>
                <a-button block @click="showPromptPreview">
                  <EyeOutlined />
                  é¢„è§ˆå¢å¼ºæç¤ºè¯
                </a-button>
              </a-space>
            </div>
          </a-col>
          
          <!-- ç»“æœå¯¼å…¥ -->
          <a-col :span="8">
            <div class="operation-section">
              <h4>ğŸ“¥ ç»“æœå¯¼å…¥</h4>
              <a-space direction="vertical" style="width: 100%;">
                <a-button 
                  type="primary" 
                  block
                  @click="showImportModal"
                >
                  <ImportOutlined />
                  å¯¼å…¥è±†åŒ…è§£æç»“æœ
                </a-button>
                <a-button block @click="validateResults">
                  <CheckCircleOutlined />
                  éªŒè¯è§£æç»“æœ
                </a-button>
                <a-button block @click="clearResults">
                  <ClearOutlined />
                  æ¸…ç©ºç»“æœ
                </a-button>
              </a-space>
            </div>
          </a-col>
          
          <!-- ä¿å­˜å’Œç»§ç»­ -->
          <a-col :span="8">
            <div class="operation-section">
              <h4>ğŸ’¾ ä¿å­˜ç»§ç»­</h4>
              <a-space direction="vertical" style="width: 100%;">
                <a-button 
                  type="primary" 
                  block
                  @click="saveAnalysisResults"
                  :loading="saving"
                >
                  <SaveOutlined />
                  ä¿å­˜è§£æç»“æœ
                </a-button>
                <a-button 
                  block
                  @click="goToNextStep"
                  :disabled="!allSectionsCompleted"
                >
                  <ArrowRightOutlined />
                  ä¸‹ä¸€æ­¥ï¼šä»»åŠ¡åˆ†é…
                </a-button>
              </a-space>
            </div>
          </a-col>
        </a-row>
      </a-card>
    </div>

    <!-- è±†åŒ…è§£ææŒ‡å—æ¨¡æ€æ¡† -->
    <a-modal
      v-model:open="doubaoGuideVisible"
      title="ğŸ¤– è±†åŒ…è§£ææŒ‡å—"
      width="800px"
      :footer="null"
    >
      <DoubaoGuide @close="doubaoGuideVisible = false" />
    </a-modal>

    <!-- å¯¼å…¥è±†åŒ…ç»“æœæ¨¡æ€æ¡† -->
    <a-modal
      v-model:open="importModalVisible"
      title="ğŸ“¥ å¯¼å…¥è±†åŒ…è§£æç»“æœ"
      width="900px"
      @ok="importDoubaoResult"
      @cancel="importModalVisible = false"
      :confirmLoading="importing"
    >
      <ImportDoubaoResult
        v-model:jsonContent="importJsonContent"
        :validationResult="jsonValidation"
        @validate="validateImportJson"
      />
    </a-modal>

    <!-- ç¼–è¾‘åŒºåŸŸå†…å®¹æ¨¡æ€æ¡† -->
    <a-modal
      v-model:open="editModalVisible"
      title="âœï¸ ç¼–è¾‘åŒºåŸŸå†…å®¹"
      width="800px"
      @ok="saveEdit"
      @cancel="editModalVisible = false"
      :confirmLoading="editSaving"
    >
      <EditSectionContent
        v-model:content="editingContent"
        :sectionTitle="editingSection"
      />
    </a-modal>

    <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <a-modal
      v-model:open="taskModalVisible"
      title="ğŸ¯ ä»»åŠ¡è¯¦æƒ…"
      width="1000px"
      :footer="null"
    >
      <TaskDetails
        :tasks="selectedTasks"
        :sectionTitle="selectedSection"
        @editTask="handleEditTask"
        @close="taskModalVisible = false"
      />
    </a-modal>

    <!-- æç¤ºè¯é¢„è§ˆæ¨¡æ€æ¡† -->
    <a-modal
      v-model:open="promptPreviewVisible"
      title="ğŸ‘ï¸ å¢å¼ºæç¤ºè¯é¢„è§ˆ"
      width="900px"
      :footer="null"
    >
      <PromptPreview
        :content="enhancedPromptContent"
        @copy="copyPromptContent"
        @close="promptPreviewVisible = false"
      />
    </a-modal>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted, watch } from 'vue'
import { message } from 'ant-design-vue'
import { 
  ReloadOutlined, 
  DownloadOutlined, 
  BulbOutlined, 
  ImportOutlined,
  RobotOutlined,
  LinkOutlined,
  EyeOutlined,
  CheckCircleOutlined,
  ClearOutlined,
  SaveOutlined,
  ArrowRightOutlined
} from '@ant-design/icons-vue'

// å¯¼å…¥å­ç»„ä»¶
import AnalysisSection from './AnalysisSection.vue'
import DoubaoGuide from './DoubaoGuide.vue'
import ImportDoubaoResult from './ImportDoubaoResult.vue'
import EditSectionContent from './EditSectionContent.vue'
import TaskDetails from './TaskDetails.vue'
import PromptPreview from './PromptPreview.vue'

// å¯¼å…¥å·¥å…·ç±»
import DoubaoPromptGenerator from '@/utils/doubao-prompt-generator.js'
import DoubaoResultParser from '@/utils/doubao-result-parser.js'
import TaskManagerInstance from '@/utils/task-manager.js'
import ProposalPdfService from '@/utils/proposal-pdf-service.js'

// å¯¼å…¥APIæœåŠ¡
import * as proposalAnalysisApi from '@/api/proposal-analysis.js'

// Props
const props = defineProps({
  selectedProject: {
    type: Object,
    required: true
  }
})

// Emits
const emit = defineEmits(['save', 'next'])

// å“åº”å¼æ•°æ®
const pdfUrl = ref('')
const pdfLoading = ref(false)
const documentInfo = ref(null)

// è§£æç»“æœæ•°æ®
const analysisResults = reactive({
  projectOverview: { content: '', lastModified: null },
  implementationPlan: { content: '', lastModified: null },
  technicalRoute: { content: '', lastModified: null },
  schedule: { content: '', lastModified: null },
  keyTechnologies: { content: '', lastModified: null },
  teamInfo: { content: '', lastModified: null },
  expectedBenefits: { content: '', lastModified: null }
})

// æå–çš„ä»»åŠ¡æ•°æ®
const extractedTasks = reactive({
  implementationTasks: [],
  technicalTasks: [],
  milestoneTasks: [],
  researchTasks: [],
  projectOverview: []
})

// ä»»åŠ¡æ‘˜è¦
const taskSummary = ref({
  totalTasks: 0,
  tasksByType: {},
  estimatedTotalDuration: 0,
  criticalPath: [],
  riskTasks: []
})

// æ¨¡æ€æ¡†çŠ¶æ€
const doubaoGuideVisible = ref(false)
const importModalVisible = ref(false)
const editModalVisible = ref(false)
const taskModalVisible = ref(false)
const promptPreviewVisible = ref(false)

// æ“ä½œçŠ¶æ€
const copyingPrompt = ref(false)
const importing = ref(false)
const saving = ref(false)
const editSaving = ref(false)

// ç¼–è¾‘ç›¸å…³æ•°æ®
const editingSection = ref('')
const editingContent = ref('')
const selectedTasks = ref([])
const selectedSection = ref('')

// å¯¼å…¥ç›¸å…³æ•°æ®
const importJsonContent = ref('')
const jsonValidation = ref(null)

// å¢å¼ºæç¤ºè¯å†…å®¹
const enhancedPromptContent = ref('')

// å·¥å…·ç±»å®ä¾‹
const promptGenerator = DoubaoPromptGenerator
const resultParser = DoubaoResultParser
const taskManager = TaskManagerInstance
const pdfService = ProposalPdfService

// è®¡ç®—å±æ€§
const allSectionsCompleted = computed(() => {
  const requiredSections = ['implementationPlan', 'technicalRoute', 'schedule']
  return requiredSections.every(section => 
    analysisResults[section].content && analysisResults[section].content.trim().length > 0
  )
})

// æ–¹æ³•å®šä¹‰

/**
 * è·å–è§£æçŠ¶æ€é¢œè‰²
 */
const getParseStatusColor = () => {
  if (taskSummary.value.totalTasks > 0) return 'green'
  if (Object.values(analysisResults).some(section => section.content)) return 'orange'
  return 'default'
}

/**
 * è·å–è§£æçŠ¶æ€æ–‡æœ¬
 */
const getParseStatusText = () => {
  if (taskSummary.value.totalTasks > 0) return `âœ… å·²å®Œæˆ (${taskSummary.value.totalTasks}ä¸ªä»»åŠ¡)`
  if (Object.values(analysisResults).some(section => section.content)) return 'ğŸ”„ éƒ¨åˆ†å®Œæˆ'
  return 'â³ å¾…è§£æ'
}

/**
 * åˆ·æ–°PDF
 */
const refreshPdf = async () => {
  if (!props.selectedProject?.id) return
  
  try {
    pdfLoading.value = true
    const url = await pdfService.convertToPdf(props.selectedProject.id)
    pdfUrl.value = url
    
    // è·å–PDFä¿¡æ¯
    const info = await pdfService.getPdfInfo(url)
    documentInfo.value = {
      filename: `${props.selectedProject.name || 'ç”³æŠ¥ä¹¦'}.pdf`,
      fileSize: formatFileSize(info.fileSize),
      pageCount: info.pageCount || 0
    }
    
    message.success('PDFé¢„è§ˆåˆ·æ–°æˆåŠŸ')
  } catch (error) {
    message.error('PDFé¢„è§ˆåˆ·æ–°å¤±è´¥ï¼š' + error.message)
  } finally {
    pdfLoading.value = false
  }
}

/**
 * ä¸‹è½½PDF
 */
const downloadPdf = () => {
  if (pdfUrl.value) {
    const link = document.createElement('a')
    link.href = pdfUrl.value
    link.download = documentInfo.value?.filename || 'proposal.pdf'
    link.click()
  } else {
    message.warning('PDFæ–‡ä»¶å°šæœªç”Ÿæˆ')
  }
}

/**
 * å¤åˆ¶å¢å¼ºæç¤ºè¯
 */
const copyEnhancedPrompt = async () => {
  try {
    copyingPrompt.value = true
    
    // è·å–ç”³æŠ¥ä¹¦å†…å®¹
    const documentContent = await getDocumentContent()
    
    // ç”Ÿæˆå¢å¼ºæç¤ºè¯
    const prompt = promptGenerator.generateEnhancedPrompt(documentContent)
    enhancedPromptContent.value = prompt
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    await navigator.clipboard.writeText(prompt)
    
    message.success('å¢å¼ºæç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼è¯·ç²˜è´´åˆ°è±†åŒ…ä¸­è¿›è¡Œè§£æã€‚')
  } catch (error) {
    message.error('å¤åˆ¶æç¤ºè¯å¤±è´¥ï¼š' + error.message)
  } finally {
    copyingPrompt.value = false
  }
}

/**
 * è·å–ç”³æŠ¥ä¹¦å†…å®¹
 */
const getDocumentContent = async () => {
  // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯APIè·å–ç”³æŠ¥ä¹¦å†…å®¹
  // æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®
  return `é¡¹ç›®åç§°ï¼š${props.selectedProject?.name || 'ç¤ºä¾‹é¡¹ç›®'}
ç”³è¯·å•ä½ï¼šååŒ—æ°´åˆ©æ°´ç”µå¤§å­¦
é¡¹ç›®è´Ÿè´£äººï¼šå¼ ä¸‰
ç ”ç©¶å†…å®¹ï¼šæœ¬é¡¹ç›®æ—¨åœ¨...
å®æ–½æ–¹æ¡ˆï¼š
ä¸€ã€éœ€æ±‚åˆ†æå’Œç³»ç»Ÿè®¾è®¡
äºŒã€æ ¸å¿ƒç®—æ³•ç ”å‘
ä¸‰ã€ç³»ç»Ÿé›†æˆæµ‹è¯•
æŠ€æœ¯è·¯çº¿ï¼š
1. æ•°æ®é‡‡é›†ä¸é¢„å¤„ç†
2. ç®—æ³•æ¨¡å‹æ„å»º
3. ç³»ç»Ÿå¼€å‘ä¸ä¼˜åŒ–
è¿›åº¦è®¡åˆ’ï¼š
ç¬¬ä¸€é˜¶æ®µï¼ˆ1-6ä¸ªæœˆï¼‰ï¼šéœ€æ±‚åˆ†æ
ç¬¬äºŒé˜¶æ®µï¼ˆ7-12ä¸ªæœˆï¼‰ï¼šç³»ç»Ÿå¼€å‘
ç¬¬ä¸‰é˜¶æ®µï¼ˆ13-18ä¸ªæœˆï¼‰ï¼šæµ‹è¯•éªŒæ”¶`
}

/**
 * æ‰“å¼€è±†åŒ…ç½‘ç«™
 */
const openDoubaoWebsite = () => {
  window.open('https://www.doubao.com/chat/', '_blank')
}

/**
 * æ˜¾ç¤ºæç¤ºè¯é¢„è§ˆ
 */
const showPromptPreview = async () => {
  try {
    const documentContent = await getDocumentContent()
    enhancedPromptContent.value = promptGenerator.generateEnhancedPrompt(documentContent)
    promptPreviewVisible.value = true
  } catch (error) {
    message.error('ç”Ÿæˆæç¤ºè¯é¢„è§ˆå¤±è´¥ï¼š' + error.message)
  }
}

/**
 * æ˜¾ç¤ºè±†åŒ…è§£ææŒ‡å—
 */
const showDoubaoGuide = () => {
  doubaoGuideVisible.value = true
}

/**
 * æ˜¾ç¤ºå¯¼å…¥æ¨¡æ€æ¡†
 */
const showImportModal = () => {
  importModalVisible.value = true
}

/**
 * éªŒè¯å¯¼å…¥çš„JSON
 */
const validateImportJson = () => {
  try {
    const result = JSON.parse(importJsonContent.value)
    
    // éªŒè¯JSONç»“æ„
    const validation = resultParser.validateStructure(result)
    jsonValidation.value = validation
    
    if (validation.valid) {
      message.success('JSONæ ¼å¼éªŒè¯é€šè¿‡')
    } else {
      message.error('JSONæ ¼å¼éªŒè¯å¤±è´¥ï¼š' + validation.message)
    }
  } catch (error) {
    jsonValidation.value = {
      valid: false,
      message: 'JSONæ ¼å¼é”™è¯¯ï¼š' + error.message
    }
    message.error('JSONè§£æå¤±è´¥')
  }
}

/**
 * å¯¼å…¥è±†åŒ…è§£æç»“æœ
 */
const importDoubaoResult = async () => {
  if (!jsonValidation.value?.valid) {
    message.error('è¯·å…ˆéªŒè¯JSONæ ¼å¼')
    return
  }
  
  try {
    importing.value = true
    
    const doubaoResult = JSON.parse(importJsonContent.value)
    
    // è§£æè±†åŒ…ç»“æœ
    const parsedResult = resultParser.parseEnhancedResult(doubaoResult)
    
    // æ›´æ–°è§£æç»“æœ
    updateAnalysisResults(parsedResult)
    
    // æ›´æ–°ä»»åŠ¡æ•°æ®
    updateExtractedTasks(parsedResult.taskExtraction)
    
    // æ›´æ–°ä»»åŠ¡æ‘˜è¦
    taskSummary.value = parsedResult.taskSummary
    
    // å¯¼å…¥ä»»åŠ¡åˆ°ä»»åŠ¡ç®¡ç†å™¨
    taskManager.importDoubaoTasks(parsedResult.taskExtraction)
    
    message.success(`è±†åŒ…è§£æç»“æœå¯¼å…¥æˆåŠŸï¼å…±æå–${parsedResult.taskSummary.totalTasks}ä¸ªä»»åŠ¡`)
    importModalVisible.value = false
    
  } catch (error) {
    message.error('å¯¼å…¥å¤±è´¥ï¼š' + error.message)
  } finally {
    importing.value = false
  }
}

/**
 * æ›´æ–°è§£æç»“æœ
 */
const updateAnalysisResults = (parsedResult) => {
  // æ›´æ–°å„åŒºåŸŸå†…å®¹
  analysisResults.projectOverview.content = resultParser.extractProjectOverview(parsedResult)
  analysisResults.implementationPlan.content = resultParser.extractImplementationPlan(parsedResult)
  analysisResults.technicalRoute.content = resultParser.extractTechnicalRoute(parsedResult)
  analysisResults.schedule.content = resultParser.extractSchedule(parsedResult)
  analysisResults.keyTechnologies.content = resultParser.extractKeyTechnologies(parsedResult)
  analysisResults.teamInfo.content = resultParser.extractTeamInfo(parsedResult)
  analysisResults.expectedBenefits.content = resultParser.extractExpectedBenefits(parsedResult)
  
  // æ›´æ–°æ—¶é—´æˆ³
  const now = new Date().toISOString()
  Object.keys(analysisResults).forEach(key => {
    analysisResults[key].lastModified = now
  })
}

/**
 * æ›´æ–°æå–çš„ä»»åŠ¡
 */
const updateExtractedTasks = (taskExtraction) => {
  extractedTasks.implementationTasks = taskExtraction.implementationTasks || []
  extractedTasks.technicalTasks = taskExtraction.technicalTasks || []
  extractedTasks.milestoneTasks = taskExtraction.milestoneTasks || []
  extractedTasks.researchTasks = taskExtraction.researchTasks || []
}

/**
 * å¤„ç†ç¼–è¾‘
 */
const handleEdit = (data) => {
  editingSection.value = data.section
  editingContent.value = data.data.content
  editModalVisible.value = true
}

/**
 * ä¿å­˜ç¼–è¾‘
 */
const saveEdit = async () => {
  try {
    editSaving.value = true
    
    // æ›´æ–°å¯¹åº”åŒºåŸŸçš„å†…å®¹
    const sectionKey = getSectionKey(editingSection.value)
    if (sectionKey && analysisResults[sectionKey]) {
      analysisResults[sectionKey].content = editingContent.value
      analysisResults[sectionKey].lastModified = new Date().toISOString()
    }
    
    message.success('ç¼–è¾‘ä¿å­˜æˆåŠŸ')
    editModalVisible.value = false
  } catch (error) {
    message.error('ä¿å­˜å¤±è´¥ï¼š' + error.message)
  } finally {
    editSaving.value = false
  }
}

/**
 * æŸ¥çœ‹ä»»åŠ¡
 */
const handleViewTasks = (data) => {
  selectedSection.value = data.section
  selectedTasks.value = data.tasks
  taskModalVisible.value = true
}

/**
 * éªŒè¯è§£æç»“æœ
 */
const validateResults = () => {
  const issues = []
  
  // æ£€æŸ¥å¿…è¦åŒºåŸŸæ˜¯å¦æœ‰å†…å®¹
  const requiredSections = [
    { key: 'implementationPlan', name: 'å®æ–½æ–¹æ¡ˆ' },
    { key: 'technicalRoute', name: 'æŠ€æœ¯è·¯çº¿' },
    { key: 'schedule', name: 'è¿›åº¦è®¡åˆ’' }
  ]
  
  requiredSections.forEach(section => {
    if (!analysisResults[section.key].content) {
      issues.push(`${section.name}åŒºåŸŸå†…å®¹ä¸ºç©º`)
    }
  })
  
  // æ£€æŸ¥ä»»åŠ¡æ•°é‡
  if (taskSummary.value.totalTasks === 0) {
    issues.push('æœªæå–åˆ°ä»»ä½•ä»»åŠ¡')
  }
  
  if (issues.length > 0) {
    message.warning('éªŒè¯å‘ç°é—®é¢˜ï¼š' + issues.join('ã€'))
  } else {
    message.success('è§£æç»“æœéªŒè¯é€šè¿‡')
  }
}

/**
 * æ¸…ç©ºè§£æç»“æœ
 */
const clearResults = () => {
  // æ¸…ç©ºè§£æç»“æœ
  Object.keys(analysisResults).forEach(key => {
    analysisResults[key].content = ''
    analysisResults[key].lastModified = null
  })
  
  // æ¸…ç©ºä»»åŠ¡æ•°æ®
  Object.keys(extractedTasks).forEach(key => {
    extractedTasks[key] = []
  })
  
  // æ¸…ç©ºä»»åŠ¡æ‘˜è¦
  taskSummary.value = {
    totalTasks: 0,
    tasksByType: {},
    estimatedTotalDuration: 0,
    criticalPath: [],
    riskTasks: []
  }
  
  message.success('è§£æç»“æœå·²æ¸…ç©º')
}

/**
 * ä¿å­˜è§£æç»“æœ
 */
const saveAnalysisResults = async () => {
  try {
    saving.value = true
    
    const saveData = {
      projectId: props.selectedProject.id,
      analysisResults,
      extractedTasks,
      taskSummary: taskSummary.value,
      saveTime: new Date().toISOString()
    }
    
    // è°ƒç”¨APIä¿å­˜æ•°æ®
    await proposalAnalysisApi.saveAnalysisResult(saveData)
    
    message.success('è§£æç»“æœä¿å­˜æˆåŠŸ')
    emit('save', saveData)
  } catch (error) {
    message.error('ä¿å­˜å¤±è´¥ï¼š' + error.message)
  } finally {
    saving.value = false
  }
}

/**
 * è¿›å…¥ä¸‹ä¸€æ­¥
 */
const goToNextStep = () => {
  if (!allSectionsCompleted.value) {
    message.warning('è¯·å…ˆå®Œæˆå¿…è¦åŒºåŸŸçš„è§£æ')
    return
  }
  
  emit('next', {
    analysisResults,
    extractedTasks,
    taskSummary: taskSummary.value
  })
}

/**
 * è·å–åŒºåŸŸé”®å
 */
const getSectionKey = (sectionTitle) => {
  const sectionMap = {
    'ğŸ“Š é¡¹ç›®æ¦‚å†µ': 'projectOverview',
    'ğŸ› ï¸ å®æ–½æ–¹æ¡ˆ': 'implementationPlan',
    'ğŸ”¬ æŠ€æœ¯è·¯çº¿': 'technicalRoute',
    'ğŸ“… è¿›åº¦è®¡åˆ’': 'schedule',
    'ğŸ”‘ æŠ€æœ¯å…³é”®': 'keyTechnologies',
    'ğŸ‘¥ å›¢é˜Ÿä¿¡æ¯': 'teamInfo',
    'ğŸ“ˆ æ•ˆç›Šé¢„æœŸ': 'expectedBenefits'
  }
  return sectionMap[sectionTitle]
}

/**
 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
 */
const formatFileSize = (bytes) => {
  if (!bytes) return 'æœªçŸ¥'
  
  const sizes = ['Bytes', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(1024))
  return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i]
}

/**
 * å¤åˆ¶æç¤ºè¯å†…å®¹
 */
const copyPromptContent = async (content) => {
  try {
    await navigator.clipboard.writeText(content)
    message.success('æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
  } catch (error) {
    message.error('å¤åˆ¶å¤±è´¥ï¼š' + error.message)
  }
}

/**
 * å¤„ç†ç¼–è¾‘ä»»åŠ¡
 */
const handleEditTask = (task) => {
  // å®ç°ä»»åŠ¡ç¼–è¾‘é€»è¾‘
  console.log('ç¼–è¾‘ä»»åŠ¡:', task)
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(async () => {
  if (props.selectedProject?.id) {
    await refreshPdf()
  }
})

// ç›‘å¬é¡¹ç›®å˜åŒ–
watch(() => props.selectedProject, async (newProject) => {
  if (newProject?.id) {
    await refreshPdf()
    // æ¸…ç©ºå½“å‰è§£æç»“æœ
    clearResults()
  }
})
</script>

<style scoped>
.proposal-analysis-step-v3 {
  padding: 20px;
}

.step-description {
  margin-bottom: 24px;
}

.step-description h3 {
  color: #1890ff;
  margin-bottom: 8px;
}

.analysis-guide ul {
  margin: 8px 0;
  padding-left: 20px;
}

.main-content {
  margin-bottom: 24px;
}

.pdf-preview-card {
  height: 100%;
}

.pdf-viewer-container {
  height: 500px;
  border: 1px solid #f0f0f0;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 16px;
}

.pdf-viewer {
  width: 100%;
  height: 100%;
}

.pdf-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #999;
}

.document-info {
  margin-top: 16px;
}

.analysis-results-card {
  height: 100%;
}

.analysis-sections {
  max-height: 600px;
  overflow-y: auto;
}

.operation-area {
  margin-top: 24px;
}

.operation-section h4 {
  margin-bottom: 12px;
  color: #333;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1200px) {
  .main-content .ant-col:first-child {
    margin-bottom: 24px;
  }
}

@media (max-width: 768px) {
  .proposal-analysis-step-v3 {
    padding: 12px;
  }
  
  .pdf-viewer-container {
    height: 300px;
  }
  
  .analysis-sections {
    max-height: 400px;
  }
  
  .operation-area .ant-col {
    margin-bottom: 16px;
  }
}
</style>
