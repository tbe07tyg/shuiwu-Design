<!--
 * @file æç¤ºè¯é¢„è§ˆç»„ä»¶
 * @description é¢„è§ˆè±†åŒ…AIè§£ææç¤ºè¯å†…å®¹
 * @author ç§‘ç ”ç®¡ç†ç³»ç»Ÿ
 * @version 3.0.0
 * @date 2025-01-29
-->
<template>
  <div class="prompt-preview">
    <!-- é¢„è§ˆå¤´éƒ¨ -->
    <div class="preview-header">
      <h3>ğŸ¤– è±†åŒ…å¢å¼ºæç¤ºè¯é¢„è§ˆ</h3>
      <a-space>
        <a-button size="small" @click="copyContent">
          <CopyOutlined />
          å¤åˆ¶å…¨éƒ¨
        </a-button>
        <a-button size="small" @click="downloadPrompt">
          <DownloadOutlined />
          ä¸‹è½½
        </a-button>
        <a-button size="small" @click="$emit('close')">
          å…³é—­
        </a-button>
      </a-space>
    </div>

    <!-- æç¤ºè¯ç»Ÿè®¡ -->
    <div class="prompt-stats">
      <a-row :gutter="16">
        <a-col :span="6">
          <a-statistic title="å­—ç¬¦æ•°" :value="stats.characterCount" />
        </a-col>
        <a-col :span="6">
          <a-statistic title="è¯æ•°" :value="stats.wordCount" />
        </a-col>
        <a-col :span="6">
          <a-statistic title="è¡Œæ•°" :value="stats.lineCount" />
        </a-col>
        <a-col :span="6">
          <a-statistic title="é¢„ä¼°Token" :value="stats.estimatedTokens" />
        </a-col>
      </a-row>
    </div>

    <!-- æç¤ºè¯å†…å®¹ -->
    <div class="prompt-content">
      <div class="content-toolbar">
        <a-space>
          <a-button size="small" @click="toggleLineNumbers">
            <NumberOutlined />
            {{ showLineNumbers ? 'éšè—' : 'æ˜¾ç¤º' }}è¡Œå·
          </a-button>
          <a-button size="small" @click="toggleWordWrap">
            <AlignLeftOutlined />
            {{ wordWrap ? 'å–æ¶ˆ' : 'å¯ç”¨' }}æ¢è¡Œ
          </a-button>
          <a-select v-model:value="fontSize" size="small" style="width: 80px;">
            <a-select-option value="12">12px</a-select-option>
            <a-select-option value="14">14px</a-select-option>
            <a-select-option value="16">16px</a-select-option>
            <a-select-option value="18">18px</a-select-option>
          </a-select>
        </a-space>
      </div>
      
      <div 
        class="prompt-text"
        :class="{ 'show-line-numbers': showLineNumbers, 'word-wrap': wordWrap }"
        :style="{ fontSize: fontSize + 'px' }"
      >
        <pre v-if="showLineNumbers" class="line-numbers">{{ lineNumbers }}</pre>
        <pre class="content-text">{{ content }}</pre>
      </div>
    </div>

    <!-- æç¤ºè¯ç»“æ„åˆ†æ -->
    <div class="prompt-analysis">
      <a-collapse>
        <a-collapse-panel key="structure" header="ğŸ“‹ æç¤ºè¯ç»“æ„åˆ†æ">
          <div class="structure-analysis">
            <a-descriptions :column="2" bordered size="small">
              <a-descriptions-item label="åŸºç¡€ä¿¡æ¯éƒ¨åˆ†">
                <a-tag color="blue">âœ“ åŒ…å«</a-tag>
              </a-descriptions-item>
              <a-descriptions-item label="ç ”ç©¶å†…å®¹éƒ¨åˆ†">
                <a-tag color="blue">âœ“ åŒ…å«</a-tag>
              </a-descriptions-item>
              <a-descriptions-item label="ä»»åŠ¡æå–æŒ‡ä»¤">
                <a-tag color="green">âœ“ å¢å¼ºç‰ˆ</a-tag>
              </a-descriptions-item>
              <a-descriptions-item label="JSONç»“æ„å®šä¹‰">
                <a-tag color="blue">âœ“ å®Œæ•´</a-tag>
              </a-descriptions-item>
              <a-descriptions-item label="ä»»åŠ¡æ‹†è§£æŒ‡å—">
                <a-tag color="green">âœ“ è¯¦ç»†</a-tag>
              </a-descriptions-item>
              <a-descriptions-item label="æ³¨æ„äº‹é¡¹">
                <a-tag color="orange">âœ“ å®Œå¤‡</a-tag>
              </a-descriptions-item>
            </a-descriptions>
          </div>
        </a-collapse-panel>
        
        <a-collapse-panel key="sections" header="ğŸ” å†…å®¹åŒºå—åˆ†æ">
          <div class="sections-analysis">
            <div v-for="section in contentSections" :key="section.name" class="section-item">
              <div class="section-header">
                <h4>{{ section.name }}</h4>
                <a-tag :color="section.status === 'complete' ? 'green' : 'orange'">
                  {{ section.status === 'complete' ? 'å®Œæ•´' : 'éƒ¨åˆ†' }}
                </a-tag>
              </div>
              <p class="section-description">{{ section.description }}</p>
              <div class="section-stats">
                <span>å­—ç¬¦æ•°: {{ section.length }}</span>
                <span>å æ¯”: {{ ((section.length / content.length) * 100).toFixed(1) }}%</span>
              </div>
            </div>
          </div>
        </a-collapse-panel>
        
        <a-collapse-panel key="validation" header="âœ… æç¤ºè¯éªŒè¯">
          <div class="validation-results">
            <a-list :data-source="validationResults" size="small">
              <template #renderItem="{ item }">
                <a-list-item>
                  <a-list-item-meta>
                    <template #avatar>
                      <a-avatar :style="{ backgroundColor: item.status === 'pass' ? '#52c41a' : '#ff4d4f' }">
                        {{ item.status === 'pass' ? 'âœ“' : 'âœ—' }}
                      </a-avatar>
                    </template>
                    <template #title>
                      {{ item.title }}
                    </template>
                    <template #description>
                      {{ item.description }}
                    </template>
                  </a-list-item-meta>
                </a-list-item>
              </template>
            </a-list>
          </div>
        </a-collapse-panel>
        
        <a-collapse-panel key="optimization" header="ğŸš€ ä¼˜åŒ–å»ºè®®">
          <div class="optimization-suggestions">
            <a-alert
              v-for="suggestion in optimizationSuggestions"
              :key="suggestion.type"
              :message="suggestion.title"
              :description="suggestion.description"
              :type="suggestion.level"
              show-icon
              style="margin-bottom: 8px;"
            />
          </div>
        </a-collapse-panel>
      </a-collapse>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="quick-actions">
      <a-divider>å¿«é€Ÿæ“ä½œ</a-divider>
      <a-space wrap>
        <a-button @click="copySection('header')">
          <CopyOutlined />
          å¤åˆ¶å¤´éƒ¨
        </a-button>
        <a-button @click="copySection('json')">
          <CopyOutlined />
          å¤åˆ¶JSONç»“æ„
        </a-button>
        <a-button @click="copySection('guide')">
          <CopyOutlined />
          å¤åˆ¶æ‹†è§£æŒ‡å—
        </a-button>
        <a-button @click="copySection('notes')">
          <CopyOutlined />
          å¤åˆ¶æ³¨æ„äº‹é¡¹
        </a-button>
        <a-button @click="openDoubao">
          <LinkOutlined />
          æ‰“å¼€è±†åŒ…
        </a-button>
      </a-space>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { message } from 'ant-design-vue'
import { 
  CopyOutlined, 
  DownloadOutlined,
  NumberOutlined,
  AlignLeftOutlined,
  LinkOutlined
} from '@ant-design/icons-vue'

// Props
const props = defineProps({
  content: {
    type: String,
    required: true
  }
})

// Emits
const emit = defineEmits(['copy', 'close'])

// å“åº”å¼æ•°æ®
const showLineNumbers = ref(true)
const wordWrap = ref(true)
const fontSize = ref('14')

// è®¡ç®—å±æ€§
const stats = computed(() => {
  const content = props.content
  return {
    characterCount: content.length,
    wordCount: content.split(/\s+/).filter(word => word.length > 0).length,
    lineCount: content.split('\n').length,
    estimatedTokens: Math.ceil(content.length / 4)
  }
})

const lineNumbers = computed(() => {
  const lines = props.content.split('\n')
  return lines.map((_, index) => (index + 1).toString().padStart(3, ' ')).join('\n')
})

const contentSections = computed(() => {
  const content = props.content
  const sections = []
  
  // åˆ†æä¸åŒåŒºå—
  const sectionPatterns = [
    { name: 'ğŸ“‹ è§£æè¦æ±‚', pattern: /ã€è§£æè¦æ±‚ã€‘[\s\S]*?(?=ã€|$)/, description: 'åŸºç¡€è§£ææŒ‡ä»¤' },
    { name: 'ğŸ¯ ä»»åŠ¡æå–æŒ‡å—', pattern: /ã€ä»»åŠ¡æå–æŒ‡å—ã€‘[\s\S]*?(?=ã€|$)/, description: 'ä»»åŠ¡æ‹†è§£æŒ‡å¯¼' },
    { name: 'ğŸ“ JSONç»“æ„', pattern: /```json[\s\S]*?```/, description: 'JSONæ ¼å¼å®šä¹‰' },
    { name: 'âš ï¸ ç‰¹åˆ«æ³¨æ„', pattern: /ã€ç‰¹åˆ«æ³¨æ„ã€‘[\s\S]*?(?=ã€|$)/, description: 'é‡è¦æé†’äº‹é¡¹' },
    { name: 'ğŸ“„ ç”³æŠ¥ä¹¦å†…å®¹', pattern: /ã€ç”³æŠ¥ä¹¦å†…å®¹ã€‘[\s\S]*?(?=ã€|$)/, description: 'å®é™…æ–‡æ¡£å†…å®¹' }
  ]
  
  sectionPatterns.forEach(pattern => {
    const match = content.match(pattern.pattern)
    if (match) {
      sections.push({
        name: pattern.name,
        description: pattern.description,
        length: match[0].length,
        status: 'complete'
      })
    } else {
      sections.push({
        name: pattern.name,
        description: pattern.description,
        length: 0,
        status: 'missing'
      })
    }
  })
  
  return sections
})

const validationResults = computed(() => {
  const content = props.content
  const results = []
  
  // éªŒè¯å„é¡¹å†…å®¹
  results.push({
    title: 'JSONæ ¼å¼æ ‡è®°',
    description: 'æ£€æŸ¥æ˜¯å¦åŒ…å«```jsonæ ‡è®°',
    status: content.includes('```json') ? 'pass' : 'fail'
  })
  
  results.push({
    title: 'ä»»åŠ¡æå–æŒ‡ä»¤',
    description: 'æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»åŠ¡æå–ç›¸å…³æŒ‡ä»¤',
    status: content.includes('taskExtraction') ? 'pass' : 'fail'
  })
  
  results.push({
    title: 'ç”³æŠ¥ä¹¦å†…å®¹å ä½ç¬¦',
    description: 'æ£€æŸ¥æ˜¯å¦åŒ…å«å†…å®¹å ä½ç¬¦',
    status: content.includes('{ç”³æŠ¥ä¹¦å®Œæ•´å†…å®¹}') || content.includes('ã€ç”³æŠ¥ä¹¦å†…å®¹ã€‘') ? 'pass' : 'fail'
  })
  
  results.push({
    title: 'ä»»åŠ¡ç±»å‹å®šä¹‰',
    description: 'æ£€æŸ¥æ˜¯å¦å®šä¹‰äº†æ‰€æœ‰ä»»åŠ¡ç±»å‹',
    status: ['implementationTasks', 'technicalTasks', 'milestoneTasks', 'researchTasks'].every(type => content.includes(type)) ? 'pass' : 'fail'
  })
  
  return results
})

const optimizationSuggestions = computed(() => {
  const suggestions = []
  const content = props.content
  
  // é•¿åº¦æ£€æŸ¥
  if (content.length > 10000) {
    suggestions.push({
      type: 'length',
      title: 'æç¤ºè¯è¿‡é•¿',
      description: 'å½“å‰æç¤ºè¯è¾ƒé•¿ï¼Œå¯èƒ½å½±å“AIå¤„ç†æ•ˆç‡ï¼Œå»ºè®®é€‚å½“ç²¾ç®€',
      level: 'warning'
    })
  }
  
  // ç»“æ„æ£€æŸ¥
  if (!content.includes('ã€ä»»åŠ¡æå–æŒ‡å—ã€‘')) {
    suggestions.push({
      type: 'structure',
      title: 'ç¼ºå°‘ä»»åŠ¡æå–æŒ‡å—',
      description: 'å»ºè®®æ·»åŠ è¯¦ç»†çš„ä»»åŠ¡æå–æŒ‡å¯¼ï¼Œæé«˜AIç†è§£å‡†ç¡®æ€§',
      level: 'error'
    })
  }
  
  // ç¤ºä¾‹æ£€æŸ¥
  if (!content.includes('ç¤ºä¾‹') && !content.includes('ä¾‹å¦‚')) {
    suggestions.push({
      type: 'examples',
      title: 'å»ºè®®æ·»åŠ ç¤ºä¾‹',
      description: 'æ·»åŠ å…·ä½“ç¤ºä¾‹å¯ä»¥å¸®åŠ©AIæ›´å¥½åœ°ç†è§£æœŸæœ›çš„è¾“å‡ºæ ¼å¼',
      level: 'info'
    })
  }
  
  return suggestions
})

// æ–¹æ³•å®šä¹‰

/**
 * å¤åˆ¶å…¨éƒ¨å†…å®¹
 */
const copyContent = async () => {
  try {
    await navigator.clipboard.writeText(props.content)
    message.success('æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
    emit('copy', props.content)
  } catch (error) {
    message.error('å¤åˆ¶å¤±è´¥')
  }
}

/**
 * ä¸‹è½½æç¤ºè¯
 */
const downloadPrompt = () => {
  const blob = new Blob([props.content], { type: 'text/plain;charset=utf-8' })
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = `è±†åŒ…å¢å¼ºæç¤ºè¯_${new Date().toISOString().slice(0, 10)}.txt`
  link.click()
  URL.revokeObjectURL(url)
  message.success('æç¤ºè¯å·²ä¸‹è½½')
}

/**
 * åˆ‡æ¢è¡Œå·æ˜¾ç¤º
 */
const toggleLineNumbers = () => {
  showLineNumbers.value = !showLineNumbers.value
}

/**
 * åˆ‡æ¢è‡ªåŠ¨æ¢è¡Œ
 */
const toggleWordWrap = () => {
  wordWrap.value = !wordWrap.value
}

/**
 * å¤åˆ¶æŒ‡å®šåŒºå—
 */
const copySection = async (sectionType) => {
  const content = props.content
  let sectionContent = ''
  
  switch (sectionType) {
    case 'header':
      const headerMatch = content.match(/^[\s\S]*?(?=ã€ç”³æŠ¥ä¹¦å†…å®¹ã€‘)/)
      sectionContent = headerMatch ? headerMatch[0] : ''
      break
    case 'json':
      const jsonMatch = content.match(/```json[\s\S]*?```/)
      sectionContent = jsonMatch ? jsonMatch[0] : ''
      break
    case 'guide':
      const guideMatch = content.match(/ã€ä»»åŠ¡æå–æŒ‡å—ã€‘[\s\S]*?(?=ã€|$)/)
      sectionContent = guideMatch ? guideMatch[0] : ''
      break
    case 'notes':
      const notesMatch = content.match(/ã€ç‰¹åˆ«æ³¨æ„ã€‘[\s\S]*?(?=ã€|$)/)
      sectionContent = notesMatch ? notesMatch[0] : ''
      break
  }
  
  if (sectionContent) {
    try {
      await navigator.clipboard.writeText(sectionContent)
      message.success('åŒºå—å†…å®¹å·²å¤åˆ¶')
    } catch (error) {
      message.error('å¤åˆ¶å¤±è´¥')
    }
  } else {
    message.warning('æœªæ‰¾åˆ°å¯¹åº”åŒºå—å†…å®¹')
  }
}

/**
 * æ‰“å¼€è±†åŒ…ç½‘ç«™
 */
const openDoubao = () => {
  window.open('https://www.doubao.com/chat/', '_blank')
}
</script>

<style scoped>
.prompt-preview {
  max-height: 80vh;
  overflow-y: auto;
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #f0f0f0;
}

.preview-header h3 {
  margin: 0;
  color: #333;
}

.prompt-stats {
  margin-bottom: 16px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 6px;
}

.prompt-content {
  margin-bottom: 24px;
}

.content-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-bottom: none;
  border-radius: 6px 6px 0 0;
}

.prompt-text {
  display: flex;
  border: 1px solid #e9ecef;
  border-radius: 0 0 6px 6px;
  background: #fff;
  max-height: 400px;
  overflow: auto;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

.prompt-text.word-wrap .content-text {
  white-space: pre-wrap;
  word-wrap: break-word;
}

.line-numbers {
  background: #f8f9fa;
  color: #999;
  padding: 12px 8px;
  margin: 0;
  border-right: 1px solid #e9ecef;
  user-select: none;
  min-width: 50px;
  text-align: right;
}

.content-text {
  flex: 1;
  padding: 12px;
  margin: 0;
  white-space: pre;
  overflow-x: auto;
  line-height: 1.5;
}

.prompt-analysis {
  margin-bottom: 24px;
}

.structure-analysis {
  margin-bottom: 16px;
}

.sections-analysis {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.section-item {
  padding: 12px;
  border: 1px solid #f0f0f0;
  border-radius: 6px;
  background: #fafafa;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.section-header h4 {
  margin: 0;
  font-size: 14px;
  color: #333;
}

.section-description {
  margin: 0 0 8px 0;
  color: #666;
  font-size: 13px;
}

.section-stats {
  display: flex;
  gap: 16px;
  font-size: 12px;
  color: #999;
}

.validation-results {
  max-height: 300px;
  overflow-y: auto;
}

.optimization-suggestions {
  max-height: 200px;
  overflow-y: auto;
}

.quick-actions {
  text-align: center;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .preview-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .content-toolbar {
    flex-direction: column;
    gap: 8px;
  }
  
  .prompt-text {
    flex-direction: column;
  }
  
  .line-numbers {
    border-right: none;
    border-bottom: 1px solid #e9ecef;
  }
  
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
}
</style>
