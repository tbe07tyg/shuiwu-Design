<!--
 * @file å¯¼å…¥è±†åŒ…è§£æç»“æœç»„ä»¶
 * @description ç”¨äºå¯¼å…¥å’ŒéªŒè¯è±†åŒ…AIè§£æçš„JSONç»“æœ
 * @author ç§‘ç ”ç®¡ç†ç³»ç»Ÿ
 * @version 3.0.0
 * @date 2025-01-29
-->
<template>
  <div class="import-doubao-result">
    <!-- å¯¼å…¥è¯´æ˜ -->
    <a-alert
      message="å¯¼å…¥è±†åŒ…è§£æç»“æœ"
      type="info"
      show-icon
      style="margin-bottom: 16px"
    >
      <template #description>
        <div class="import-guide">
          <p>è¯·å°†è±†åŒ…è¿”å›çš„å®Œæ•´JSONç»“æœç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨éªŒè¯æ ¼å¼å¹¶æå–ä»»åŠ¡ä¿¡æ¯ã€‚</p>
          <ul>
            <li>ç¡®ä¿å¤åˆ¶å®Œæ•´çš„JSONå†…å®¹ï¼ˆåŒ…æ‹¬å¼€å¤´çš„ { å’Œç»“å°¾çš„ } ï¼‰</li>
            <li>JSONæ ¼å¼å¿…é¡»æ­£ç¡®ï¼Œå¦åˆ™æ— æ³•å¯¼å…¥</li>
            <li>ç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯æ•°æ®ç»“æ„çš„å®Œæ•´æ€§</li>
          </ul>
        </div>
      </template>
    </a-alert>

    <!-- JSONè¾“å…¥åŒºåŸŸ -->
    <div class="json-input-section">
      <div class="input-header">
        <h4>ğŸ“¥ ç²˜è´´JSONå†…å®¹</h4>
        <a-space>
          <a-button size="small" @click="pasteFromClipboard">
            <CopyOutlined />
            ä»å‰ªè´´æ¿ç²˜è´´
          </a-button>
          <a-button size="small" @click="clearInput">
            <ClearOutlined />
            æ¸…ç©º
          </a-button>
          <a-button size="small" @click="formatJson" :disabled="!jsonContent">
            <FormatPainterOutlined />
            æ ¼å¼åŒ–
          </a-button>
        </a-space>
      </div>
      
      <a-textarea
        v-model:value="jsonContent"
        placeholder="è¯·ç²˜è´´è±†åŒ…è¿”å›çš„JSONç»“æœ..."
        :rows="12"
        class="json-textarea"
        @input="handleInput"
      />
      
      <!-- å­—ç¬¦ç»Ÿè®¡ -->
      <div class="input-stats">
        <a-space>
          <span class="stat-item">å­—ç¬¦æ•°: {{ jsonContent.length }}</span>
          <span class="stat-item">è¡Œæ•°: {{ lineCount }}</span>
          <span class="stat-item" v-if="estimatedTasks > 0">é¢„ä¼°ä»»åŠ¡: {{ estimatedTasks }}ä¸ª</span>
        </a-space>
      </div>
    </div>

    <!-- éªŒè¯ç»“æœ -->
    <div class="validation-section" v-if="validationResult">
      <h4>ğŸ” éªŒè¯ç»“æœ</h4>
      <a-alert
        :message="validationResult.valid ? 'JSONæ ¼å¼éªŒè¯é€šè¿‡' : 'JSONæ ¼å¼éªŒè¯å¤±è´¥'"
        :description="validationResult.message"
        :type="validationResult.valid ? 'success' : 'error'"
        show-icon
        style="margin-bottom: 16px"
      />
      
      <!-- è¯¦ç»†éªŒè¯ä¿¡æ¯ -->
      <div v-if="validationResult.valid && parsedData" class="validation-details">
        <a-descriptions title="è§£æç»“æœé¢„è§ˆ" :column="2" bordered size="small">
          <a-descriptions-item label="é¡¹ç›®åç§°">
            {{ parsedData.basicInfo?.projectName || 'æœªå¡«å†™' }}
          </a-descriptions-item>
          <a-descriptions-item label="ç”³è¯·å•ä½">
            {{ parsedData.basicInfo?.applicantUnit || 'æœªå¡«å†™' }}
          </a-descriptions-item>
          <a-descriptions-item label="é¡¹ç›®è´Ÿè´£äºº">
            {{ parsedData.basicInfo?.leader || 'æœªå¡«å†™' }}
          </a-descriptions-item>
          <a-descriptions-item label="æ€»ä»»åŠ¡æ•°">
            {{ getTotalTasks() }}ä¸ª
          </a-descriptions-item>
        </a-descriptions>
        
        <!-- ä»»åŠ¡ç»Ÿè®¡ -->
        <div class="task-statistics" v-if="parsedData.taskExtraction">
          <h5>ğŸ“Š ä»»åŠ¡ç»Ÿè®¡</h5>
          <a-row :gutter="16">
            <a-col :span="6">
              <a-statistic
                title="å®æ–½ä»»åŠ¡"
                :value="parsedData.taskExtraction.implementationTasks?.length || 0"
                :value-style="{ color: '#1890ff' }"
              />
            </a-col>
            <a-col :span="6">
              <a-statistic
                title="æŠ€æœ¯ä»»åŠ¡"
                :value="parsedData.taskExtraction.technicalTasks?.length || 0"
                :value-style="{ color: '#52c41a' }"
              />
            </a-col>
            <a-col :span="6">
              <a-statistic
                title="é‡Œç¨‹ç¢‘"
                :value="parsedData.taskExtraction.milestoneTasks?.length || 0"
                :value-style="{ color: '#faad14' }"
              />
            </a-col>
            <a-col :span="6">
              <a-statistic
                title="ç ”ç©¶ä»»åŠ¡"
                :value="parsedData.taskExtraction.researchTasks?.length || 0"
                :value-style="{ color: '#722ed1' }"
              />
            </a-col>
          </a-row>
        </div>
        
        <!-- ä»»åŠ¡é¢„è§ˆ -->
        <div class="task-preview" v-if="parsedData.taskExtraction">
          <h5>ğŸ¯ ä»»åŠ¡é¢„è§ˆ</h5>
          <a-tabs size="small">
            <a-tab-pane key="implementation" tab="å®æ–½ä»»åŠ¡" v-if="parsedData.taskExtraction.implementationTasks?.length > 0">
              <TaskPreviewList :tasks="parsedData.taskExtraction.implementationTasks" type="implementation" />
            </a-tab-pane>
            
            <a-tab-pane key="technical" tab="æŠ€æœ¯ä»»åŠ¡" v-if="parsedData.taskExtraction.technicalTasks?.length > 0">
              <TaskPreviewList :tasks="parsedData.taskExtraction.technicalTasks" type="technical" />
            </a-tab-pane>
            
            <a-tab-pane key="milestone" tab="é‡Œç¨‹ç¢‘" v-if="parsedData.taskExtraction.milestoneTasks?.length > 0">
              <TaskPreviewList :tasks="parsedData.taskExtraction.milestoneTasks" type="milestone" />
            </a-tab-pane>
            
            <a-tab-pane key="research" tab="ç ”ç©¶ä»»åŠ¡" v-if="parsedData.taskExtraction.researchTasks?.length > 0">
              <TaskPreviewList :tasks="parsedData.taskExtraction.researchTasks" type="research" />
            </a-tab-pane>
          </a-tabs>
        </div>
      </div>
    </div>

    <!-- å¯¼å…¥é€‰é¡¹ -->
    <div class="import-options" v-if="validationResult?.valid">
      <h4>âš™ï¸ å¯¼å…¥é€‰é¡¹</h4>
      <a-form layout="vertical">
        <a-form-item label="å¯¼å…¥æ¨¡å¼">
          <a-radio-group v-model:value="importMode">
            <a-radio value="replace">å®Œå…¨æ›¿æ¢ç°æœ‰æ•°æ®</a-radio>
            <a-radio value="merge">åˆå¹¶åˆ°ç°æœ‰æ•°æ®</a-radio>
          </a-radio-group>
        </a-form-item>
        
        <a-form-item label="ä»»åŠ¡å¤„ç†">
          <a-checkbox-group v-model:value="taskOptions">
            <a-checkbox value="validateDependencies">éªŒè¯ä»»åŠ¡ä¾èµ–å…³ç³»</a-checkbox>
            <a-checkbox value="autoAssignIds">è‡ªåŠ¨åˆ†é…ä»»åŠ¡ID</a-checkbox>
            <a-checkbox value="calculateDuration">é‡æ–°è®¡ç®—é¡¹ç›®å·¥æœŸ</a-checkbox>
          </a-checkbox-group>
        </a-form-item>
      </a-form>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="import-actions">
      <a-space>
        <a-button 
          type="primary" 
          @click="validateJson"
          :loading="validating"
          :disabled="!jsonContent.trim()"
        >
          <CheckCircleOutlined />
          éªŒè¯JSONæ ¼å¼
        </a-button>
        
        <a-button 
          @click="loadExample"
        >
          <FileTextOutlined />
          åŠ è½½ç¤ºä¾‹
        </a-button>
        
        <a-button 
          @click="clearAll"
        >
          <ClearOutlined />
          æ¸…ç©ºæ‰€æœ‰
        </a-button>
      </a-space>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { message } from 'ant-design-vue'
import { 
  CopyOutlined, 
  ClearOutlined, 
  FormatPainterOutlined,
  CheckCircleOutlined,
  FileTextOutlined
} from '@ant-design/icons-vue'
import TaskPreviewList from './TaskPreviewList.vue'

// Props
const props = defineProps({
  validationResult: {
    type: Object,
    default: null
  }
})

// Emits
const emit = defineEmits(['update:jsonContent', 'validate'])

// å“åº”å¼æ•°æ®
const jsonContent = ref('')
const validating = ref(false)
const parsedData = ref(null)
const importMode = ref('replace')
const taskOptions = ref(['validateDependencies', 'autoAssignIds'])

// è®¡ç®—å±æ€§
const lineCount = computed(() => {
  return jsonContent.value.split('\n').length
})

const estimatedTasks = computed(() => {
  const content = jsonContent.value.toLowerCase()
  const taskMatches = content.match(/"id":\s*"(impl_|tech_|mile_|research_)/g)
  return taskMatches ? taskMatches.length : 0
})

// ç›‘å¬å™¨
watch(jsonContent, (newValue) => {
  emit('update:jsonContent', newValue)
})

watch(() => props.validationResult, (newResult) => {
  if (newResult?.valid && newResult.parsedData) {
    parsedData.value = newResult.parsedData
  }
})

// æ–¹æ³•å®šä¹‰

/**
 * å¤„ç†è¾“å…¥
 */
const handleInput = () => {
  // é‡ç½®éªŒè¯ç»“æœ
  if (parsedData.value) {
    parsedData.value = null
  }
}

/**
 * ä»å‰ªè´´æ¿ç²˜è´´
 */
const pasteFromClipboard = async () => {
  try {
    const text = await navigator.clipboard.readText()
    jsonContent.value = text
    message.success('å†…å®¹å·²ä»å‰ªè´´æ¿ç²˜è´´')
  } catch (error) {
    message.error('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´')
  }
}

/**
 * æ¸…ç©ºè¾“å…¥
 */
const clearInput = () => {
  jsonContent.value = ''
  parsedData.value = null
}

/**
 * æ ¼å¼åŒ–JSON
 */
const formatJson = () => {
  try {
    const parsed = JSON.parse(jsonContent.value)
    jsonContent.value = JSON.stringify(parsed, null, 2)
    message.success('JSONæ ¼å¼åŒ–å®Œæˆ')
  } catch (error) {
    message.error('JSONæ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ ¼å¼åŒ–')
  }
}

/**
 * éªŒè¯JSON
 */
const validateJson = () => {
  if (!jsonContent.value.trim()) {
    message.warning('è¯·å…ˆè¾“å…¥JSONå†…å®¹')
    return
  }
  
  validating.value = true
  
  // å»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  setTimeout(() => {
    try {
      const parsed = JSON.parse(jsonContent.value)
      
      // è§¦å‘çˆ¶ç»„ä»¶éªŒè¯
      emit('validate', {
        content: jsonContent.value,
        parsed,
        options: {
          mode: importMode.value,
          taskOptions: taskOptions.value
        }
      })
      
    } catch (error) {
      message.error('JSONè§£æå¤±è´¥ï¼š' + error.message)
    } finally {
      validating.value = false
    }
  }, 500)
}

/**
 * åŠ è½½ç¤ºä¾‹
 */
const loadExample = () => {
  const example = {
    "basicInfo": {
      "projectName": "æ™ºèƒ½æ°´åŠ¡ç®¡ç†ç³»ç»Ÿç ”å‘",
      "applicantUnit": "ååŒ—æ°´åˆ©æ°´ç”µå¤§å­¦",
      "leader": "å¼ æ•™æˆ",
      "cooperativeUnit": "æŸç§‘æŠ€å…¬å¸",
      "applicationDate": "2025-01-01"
    },
    "researchContent": {
      "basisAndSignificance": "éšç€åŸå¸‚åŒ–è¿›ç¨‹çš„åŠ å¿«ï¼Œä¼ ç»Ÿæ°´åŠ¡ç®¡ç†é¢ä¸´è¯¸å¤šæŒ‘æˆ˜...",
      "implementation": {
        "plan": "æœ¬é¡¹ç›®é‡‡ç”¨åˆ†é˜¶æ®µå®æ–½çš„æ–¹å¼ï¼Œé¦–å…ˆè¿›è¡Œéœ€æ±‚åˆ†æ...",
        "keyTechnologies": "ç‰©è”ç½‘æŠ€æœ¯ã€å¤§æ•°æ®åˆ†æã€äººå·¥æ™ºèƒ½ç®—æ³•...",
        "technicalRoute": "æ•°æ®é‡‡é›† â†’ æ•°æ®å¤„ç† â†’ æ™ºèƒ½åˆ†æ â†’ å†³ç­–æ”¯æŒ",
        "expectedResults": "å»ºæˆæ™ºèƒ½æ°´åŠ¡ç®¡ç†å¹³å°ï¼Œå®ç°æ°´åŠ¡æ•°æ®çš„æ™ºèƒ½åŒ–ç®¡ç†"
      },
      "existingConditions": "é¡¹ç›®å›¢é˜Ÿå…·å¤‡ä¸°å¯Œçš„æ°´åŠ¡ç®¡ç†å’Œä¿¡æ¯åŒ–å»ºè®¾ç»éªŒ...",
      "expectedBenefits": "æé«˜æ°´åŠ¡ç®¡ç†æ•ˆç‡30%ï¼Œé™ä½è¿è¥æˆæœ¬20%",
      "schedule": "é¡¹ç›®æ€»å·¥æœŸ18ä¸ªæœˆï¼Œåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µå®æ–½"
    },
    "taskExtraction": {
      "implementationTasks": [
        {
          "id": "impl_001",
          "name": "éœ€æ±‚åˆ†æå’Œç³»ç»Ÿè®¾è®¡",
          "description": "è¿›è¡Œè¯¦ç»†çš„éœ€æ±‚è°ƒç ”ï¼Œå®Œæˆç³»ç»Ÿæ¶æ„è®¾è®¡å’ŒæŠ€æœ¯é€‰å‹",
          "type": "implementation",
          "priority": "high",
          "estimatedDuration": 15,
          "dependencies": [],
          "deliverables": ["éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦", "ç³»ç»Ÿè®¾è®¡æ–‡æ¡£", "æŠ€æœ¯é€‰å‹æŠ¥å‘Š"],
          "source": "å®æ–½æ–¹æ¡ˆ"
        },
        {
          "id": "impl_002",
          "name": "æ•°æ®åº“è®¾è®¡ä¸å®ç°",
          "description": "è®¾è®¡å¹¶å®ç°æ°´åŠ¡æ•°æ®çš„å­˜å‚¨ç»“æ„",
          "type": "implementation",
          "priority": "high",
          "estimatedDuration": 10,
          "dependencies": ["impl_001"],
          "deliverables": ["æ•°æ®åº“è®¾è®¡æ–‡æ¡£", "æ•°æ®åº“è„šæœ¬"],
          "source": "å®æ–½æ–¹æ¡ˆ"
        }
      ],
      "technicalTasks": [
        {
          "id": "tech_001",
          "name": "æ ¸å¿ƒç®—æ³•ç ”å‘",
          "description": "ç ”å‘æ°´åŠ¡æ•°æ®åˆ†æçš„æ ¸å¿ƒç®—æ³•",
          "type": "technical",
          "priority": "high",
          "estimatedDuration": 30,
          "dependencies": ["impl_001"],
          "technicalDifficulty": "high",
          "keyTechnologies": ["æœºå™¨å­¦ä¹ ", "æ•°æ®æŒ–æ˜", "ç®—æ³•ä¼˜åŒ–"],
          "source": "æŠ€æœ¯è·¯çº¿"
        }
      ],
      "milestoneTasks": [
        {
          "id": "mile_001",
          "name": "åŸå‹ç³»ç»Ÿå®Œæˆ",
          "description": "å®Œæˆç³»ç»ŸåŸå‹å¼€å‘ï¼Œå®ç°æ ¸å¿ƒåŠŸèƒ½",
          "type": "milestone",
          "priority": "high",
          "plannedDate": "2025-06-30",
          "dependencies": ["impl_002", "tech_001"],
          "criteria": ["åŸå‹ç³»ç»Ÿå¯è¿è¡Œ", "æ ¸å¿ƒåŠŸèƒ½éªŒè¯é€šè¿‡"],
          "source": "è¿›åº¦è®¡åˆ’"
        }
      ],
      "researchTasks": [
        {
          "id": "research_001",
          "name": "å…³é”®æŠ€æœ¯æ”»å…³",
          "description": "é’ˆå¯¹é¡¹ç›®ä¸­çš„å…³é”®æŠ€æœ¯éš¾ç‚¹è¿›è¡Œæ·±å…¥ç ”ç©¶",
          "type": "research",
          "priority": "medium",
          "estimatedDuration": 20,
          "researchMethod": "ç†è®ºåˆ†æ+å®éªŒéªŒè¯",
          "expectedOutcome": "æŠ€æœ¯å¯è¡Œæ€§æŠ¥å‘Š",
          "source": "æŠ€æœ¯å…³é”®"
        }
      ]
    },
    "taskSummary": {
      "totalTasks": 5,
      "tasksByType": {
        "implementation": 2,
        "technical": 1,
        "milestone": 1,
        "research": 1
      },
      "estimatedTotalDuration": 75,
      "criticalPath": ["impl_001", "tech_001", "mile_001"],
      "riskTasks": ["tech_001"]
    }
  }
  
  jsonContent.value = JSON.stringify(example, null, 2)
  message.success('ç¤ºä¾‹æ•°æ®å·²åŠ è½½')
}

/**
 * æ¸…ç©ºæ‰€æœ‰
 */
const clearAll = () => {
  jsonContent.value = ''
  parsedData.value = null
  importMode.value = 'replace'
  taskOptions.value = ['validateDependencies', 'autoAssignIds']
}

/**
 * è·å–æ€»ä»»åŠ¡æ•°
 */
const getTotalTasks = () => {
  if (!parsedData.value?.taskExtraction) return 0
  
  const extraction = parsedData.value.taskExtraction
  return (
    (extraction.implementationTasks?.length || 0) +
    (extraction.technicalTasks?.length || 0) +
    (extraction.milestoneTasks?.length || 0) +
    (extraction.researchTasks?.length || 0)
  )
}
</script>

<style scoped>
.import-doubao-result {
  max-height: 70vh;
  overflow-y: auto;
}

.import-guide ul {
  margin: 8px 0;
  padding-left: 20px;
}

.json-input-section {
  margin-bottom: 24px;
}

.input-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.input-header h4 {
  margin: 0;
  color: #333;
}

.json-textarea {
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 12px;
  line-height: 1.4;
}

.input-stats {
  margin-top: 8px;
  text-align: right;
}

.stat-item {
  font-size: 12px;
  color: #999;
  margin-left: 16px;
}

.validation-section {
  margin-bottom: 24px;
}

.validation-section h4 {
  color: #333;
  margin-bottom: 12px;
}

.validation-details {
  margin-top: 16px;
}

.task-statistics {
  margin: 16px 0;
}

.task-statistics h5 {
  margin-bottom: 12px;
  color: #333;
}

.task-preview {
  margin-top: 16px;
}

.task-preview h5 {
  margin-bottom: 12px;
  color: #333;
}

.import-options {
  margin-bottom: 24px;
}

.import-options h4 {
  color: #333;
  margin-bottom: 12px;
}

.import-actions {
  text-align: center;
  padding-top: 16px;
  border-top: 1px solid #f0f0f0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .input-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .json-textarea {
    font-size: 11px;
  }
  
  .input-stats {
    text-align: left;
  }
}
</style>
