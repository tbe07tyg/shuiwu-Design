<!--
 * @file ä»»åŠ¡è¯¦æƒ…ç»„ä»¶
 * @description æ˜¾ç¤ºè±†åŒ…æå–çš„ä»»åŠ¡è¯¦ç»†ä¿¡æ¯
 * @author ç§‘ç ”ç®¡ç†ç³»ç»Ÿ
 * @version 3.0.0
 * @date 2025-01-29
-->
<template>
  <div class="task-details">
    <!-- ä»»åŠ¡åˆ—è¡¨ -->
    <div class="task-list" v-if="tasks.length > 0">
      <div class="list-header">
        <h3>{{ sectionTitle }} - ä»»åŠ¡è¯¦æƒ…</h3>
        <a-space>
          <a-select v-model:value="sortBy" size="small" style="width: 120px;">
            <a-select-option value="priority">æŒ‰ä¼˜å…ˆçº§</a-select-option>
            <a-select-option value="duration">æŒ‰å·¥æœŸ</a-select-option>
            <a-select-option value="name">æŒ‰åç§°</a-select-option>
          </a-select>
          <a-select v-model:value="filterBy" size="small" style="width: 100px;">
            <a-select-option value="all">å…¨éƒ¨</a-select-option>
            <a-select-option value="high">é«˜ä¼˜å…ˆçº§</a-select-option>
            <a-select-option value="medium">ä¸­ä¼˜å…ˆçº§</a-select-option>
            <a-select-option value="low">ä½ä¼˜å…ˆçº§</a-select-option>
          </a-select>
        </a-space>
      </div>
      
      <div class="task-items">
        <div 
          v-for="(task, index) in filteredAndSortedTasks" 
          :key="task.id || index"
          class="task-detail-item"
          :class="`priority-${task.priority || 'medium'}`"
        >
          <!-- ä»»åŠ¡å¤´éƒ¨ -->
          <div class="task-header">
            <div class="task-title-section">
              <h4 class="task-name">
                <span class="task-index">{{ index + 1 }}.</span>
                {{ task.name || 'æœªå‘½åä»»åŠ¡' }}
              </h4>
              <div class="task-meta">
                <a-tag :color="getTypeColor(task.type)" size="small">
                  {{ getTypeText(task.type) }}
                </a-tag>
                <a-tag :color="getPriorityColor(task.priority)" size="small">
                  {{ getPriorityText(task.priority) }}
                </a-tag>
                <a-tag v-if="task.technicalDifficulty" :color="getDifficultyColor(task.technicalDifficulty)" size="small">
                  éš¾åº¦: {{ getDifficultyText(task.technicalDifficulty) }}
                </a-tag>
              </div>
            </div>
            
            <div class="task-actions">
              <a-space>
                <a-button size="small" @click="editTask(task)">
                  <EditOutlined />
                  ç¼–è¾‘
                </a-button>
                <a-button size="small" @click="duplicateTask(task)">
                  <CopyOutlined />
                  å¤åˆ¶
                </a-button>
                <a-dropdown>
                  <a-button size="small">
                    <MoreOutlined />
                  </a-button>
                  <template #overlay>
                    <a-menu>
                      <a-menu-item @click="moveTask(task, 'up')">
                        <ArrowUpOutlined />
                        ä¸Šç§»
                      </a-menu-item>
                      <a-menu-item @click="moveTask(task, 'down')">
                        <ArrowDownOutlined />
                        ä¸‹ç§»
                      </a-menu-item>
                      <a-menu-divider />
                      <a-menu-item @click="deleteTask(task)" danger>
                        <DeleteOutlined />
                        åˆ é™¤
                      </a-menu-item>
                    </a-menu>
                  </template>
                </a-dropdown>
              </a-space>
            </div>
          </div>
          
          <!-- ä»»åŠ¡æè¿° -->
          <div class="task-description" v-if="task.description">
            <p>{{ task.description }}</p>
          </div>
          
          <!-- ä»»åŠ¡è¯¦ç»†ä¿¡æ¯ -->
          <div class="task-info-grid">
            <a-row :gutter="16">
              <!-- åŸºç¡€ä¿¡æ¯ -->
              <a-col :span="8">
                <div class="info-section">
                  <h5>ğŸ“‹ åŸºç¡€ä¿¡æ¯</h5>
                  <a-descriptions size="small" :column="1">
                    <a-descriptions-item label="ä»»åŠ¡ID">
                      <a-typography-text copyable>{{ task.id }}</a-typography-text>
                    </a-descriptions-item>
                    <a-descriptions-item label="é¢„ä¼°å·¥æœŸ">
                      {{ task.estimatedDuration || 0 }}å¤©
                    </a-descriptions-item>
                    <a-descriptions-item label="æ¥æº">
                      {{ task.source || 'æœªçŸ¥' }}
                    </a-descriptions-item>
                    <a-descriptions-item label="åˆ›å»ºæ—¶é—´" v-if="task.createdAt">
                      {{ formatTime(task.createdAt) }}
                    </a-descriptions-item>
                  </a-descriptions>
                </div>
              </a-col>
              
              <!-- ä¾èµ–å…³ç³» -->
              <a-col :span="8">
                <div class="info-section">
                  <h5>ğŸ”— ä¾èµ–å…³ç³»</h5>
                  <div class="dependency-info">
                    <div class="dependency-item" v-if="task.dependencies && task.dependencies.length > 0">
                      <strong>å‰ç½®ä»»åŠ¡ï¼š</strong>
                      <div class="dependency-tags">
                        <a-tag 
                          v-for="depId in task.dependencies" 
                          :key="depId"
                          color="blue"
                          size="small"
                          @click="highlightTask(depId)"
                          style="cursor: pointer;"
                        >
                          {{ depId }}
                        </a-tag>
                      </div>
                    </div>
                    <div class="dependency-item" v-else>
                      <span class="no-dependency">æ— å‰ç½®ä»»åŠ¡</span>
                    </div>
                    
                    <!-- åç»­ä»»åŠ¡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ -->
                    <div class="dependency-item" v-if="getFollowingTasks(task.id).length > 0">
                      <strong>åç»­ä»»åŠ¡ï¼š</strong>
                      <div class="dependency-tags">
                        <a-tag 
                          v-for="followId in getFollowingTasks(task.id)" 
                          :key="followId"
                          color="green"
                          size="small"
                          @click="highlightTask(followId)"
                          style="cursor: pointer;"
                        >
                          {{ followId }}
                        </a-tag>
                      </div>
                    </div>
                  </div>
                </div>
              </a-col>
              
              <!-- ç‰¹æ®Šå±æ€§ -->
              <a-col :span="8">
                <div class="info-section">
                  <h5>âš¡ ç‰¹æ®Šå±æ€§</h5>
                  <div class="special-attributes">
                    <!-- æŠ€æœ¯ä»»åŠ¡ç‰¹æœ‰å±æ€§ -->
                    <div v-if="task.type === 'technical' && task.keyTechnologies" class="attribute-item">
                      <strong>å…³é”®æŠ€æœ¯ï¼š</strong>
                      <div class="tech-tags">
                        <a-tag 
                          v-for="tech in task.keyTechnologies" 
                          :key="tech"
                          color="cyan"
                          size="small"
                        >
                          {{ tech }}
                        </a-tag>
                      </div>
                    </div>
                    
                    <!-- é‡Œç¨‹ç¢‘ä»»åŠ¡ç‰¹æœ‰å±æ€§ -->
                    <div v-if="task.type === 'milestone'" class="attribute-item">
                      <strong>è®¡åˆ’æ—¥æœŸï¼š</strong>
                      <span>{{ task.plannedDate || 'å¾…å®š' }}</span>
                    </div>
                    
                    <!-- ç ”ç©¶ä»»åŠ¡ç‰¹æœ‰å±æ€§ -->
                    <div v-if="task.type === 'research'" class="attribute-item">
                      <div v-if="task.researchMethod">
                        <strong>ç ”ç©¶æ–¹æ³•ï¼š</strong>
                        <p>{{ task.researchMethod }}</p>
                      </div>
                      <div v-if="task.expectedOutcome">
                        <strong>é¢„æœŸæˆæœï¼š</strong>
                        <p>{{ task.expectedOutcome }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </a-col>
            </a-row>
          </div>
          
          <!-- äº¤ä»˜ç‰© -->
          <div class="deliverables-section" v-if="task.deliverables && task.deliverables.length > 0">
            <h5>ğŸ“¦ äº¤ä»˜ç‰©</h5>
            <div class="deliverable-list">
              <a-tag 
                v-for="(deliverable, idx) in task.deliverables" 
                :key="idx"
                color="purple"
                size="small"
                style="margin: 2px 4px 2px 0;"
              >
                {{ deliverable }}
              </a-tag>
            </div>
          </div>
          
          <!-- éªŒæ”¶æ ‡å‡† -->
          <div class="criteria-section" v-if="task.criteria && task.criteria.length > 0">
            <h5>âœ… éªŒæ”¶æ ‡å‡†</h5>
            <ul class="criteria-list">
              <li v-for="(criterion, idx) in task.criteria" :key="idx">
                {{ criterion }}
              </li>
            </ul>
          </div>
          
          <!-- ä»»åŠ¡è¿›åº¦ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ -->
          <div class="progress-section" v-if="task.progress !== undefined">
            <h5>ğŸ“Š ä»»åŠ¡è¿›åº¦</h5>
            <a-progress 
              :percent="task.progress || 0" 
              :status="getProgressStatus(task.progress)"
            />
          </div>
        </div>
      </div>
    </div>
    
    <!-- ç©ºçŠ¶æ€ -->
    <div v-else class="empty-state">
      <a-empty description="æš‚æ— ä»»åŠ¡è¯¦æƒ…" />
    </div>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="task-statistics" v-if="tasks.length > 0">
      <a-divider>ä»»åŠ¡ç»Ÿè®¡</a-divider>
      <a-row :gutter="16">
        <a-col :span="6">
          <a-statistic
            title="ä»»åŠ¡æ€»æ•°"
            :value="tasks.length"
            :value-style="{ color: '#1890ff' }"
          />
        </a-col>
        <a-col :span="6">
          <a-statistic
            title="å¹³å‡å·¥æœŸ"
            :value="averageDuration"
            suffix="å¤©"
            :value-style="{ color: '#52c41a' }"
          />
        </a-col>
        <a-col :span="6">
          <a-statistic
            title="æ€»é¢„ä¼°å·¥æœŸ"
            :value="totalDuration"
            suffix="å¤©"
            :value-style="{ color: '#faad14' }"
          />
        </a-col>
        <a-col :span="6">
          <a-statistic
            title="æœ‰ä¾èµ–ä»»åŠ¡"
            :value="tasksWithDependencies"
            :value-style="{ color: '#722ed1' }"
          />
        </a-col>
      </a-row>
    </div>
    
    <!-- æ“ä½œåŒºåŸŸ -->
    <div class="action-area" v-if="tasks.length > 0">
      <a-divider>æ‰¹é‡æ“ä½œ</a-divider>
      <a-space>
        <a-button @click="exportTasks">
          <ExportOutlined />
          å¯¼å‡ºä»»åŠ¡
        </a-button>
        <a-button @click="generateGantt">
          <BarChartOutlined />
          ç”Ÿæˆç”˜ç‰¹å›¾
        </a-button>
        <a-button @click="analyzeDepedencies">
          <NodeIndexOutlined />
          ä¾èµ–åˆ†æ
        </a-button>
        <a-button @click="optimizeTasks">
          <ThunderboltOutlined />
          ä»»åŠ¡ä¼˜åŒ–
        </a-button>
      </a-space>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import { message } from 'ant-design-vue'
import { 
  EditOutlined, 
  CopyOutlined, 
  MoreOutlined,
  ArrowUpOutlined,
  ArrowDownOutlined,
  DeleteOutlined,
  ExportOutlined,
  BarChartOutlined,
  NodeIndexOutlined,
  ThunderboltOutlined
} from '@ant-design/icons-vue'

// Props
const props = defineProps({
  tasks: {
    type: Array,
    default: () => []
  },
  sectionTitle: {
    type: String,
    default: 'ä»»åŠ¡è¯¦æƒ…'
  }
})

// Emits
const emit = defineEmits(['editTask', 'close'])

// å“åº”å¼æ•°æ®
const sortBy = ref('priority')
const filterBy = ref('all')

// è®¡ç®—å±æ€§
const filteredAndSortedTasks = computed(() => {
  let filtered = props.tasks
  
  // è¿‡æ»¤
  if (filterBy.value !== 'all') {
    filtered = filtered.filter(task => task.priority === filterBy.value)
  }
  
  // æ’åº
  filtered = [...filtered].sort((a, b) => {
    switch (sortBy.value) {
      case 'priority':
        const priorityOrder = { high: 3, medium: 2, low: 1 }
        return (priorityOrder[b.priority] || 2) - (priorityOrder[a.priority] || 2)
      case 'duration':
        return (b.estimatedDuration || 0) - (a.estimatedDuration || 0)
      case 'name':
        return (a.name || '').localeCompare(b.name || '')
      default:
        return 0
    }
  })
  
  return filtered
})

const averageDuration = computed(() => {
  const tasksWithDuration = props.tasks.filter(task => task.estimatedDuration > 0)
  if (tasksWithDuration.length === 0) return 0
  
  const total = tasksWithDuration.reduce((sum, task) => sum + task.estimatedDuration, 0)
  return Math.round(total / tasksWithDuration.length)
})

const totalDuration = computed(() => {
  return props.tasks.reduce((sum, task) => sum + (task.estimatedDuration || 0), 0)
})

const tasksWithDependencies = computed(() => {
  return props.tasks.filter(task => task.dependencies && task.dependencies.length > 0).length
})

// æ–¹æ³•å®šä¹‰

/**
 * è·å–ä»»åŠ¡ç±»å‹é¢œè‰²
 */
const getTypeColor = (type) => {
  const colorMap = {
    implementation: 'blue',
    technical: 'green',
    milestone: 'orange',
    research: 'purple'
  }
  return colorMap[type] || 'default'
}

/**
 * è·å–ä»»åŠ¡ç±»å‹æ–‡æœ¬
 */
const getTypeText = (type) => {
  const textMap = {
    implementation: 'å®æ–½ä»»åŠ¡',
    technical: 'æŠ€æœ¯ä»»åŠ¡',
    milestone: 'é‡Œç¨‹ç¢‘',
    research: 'ç ”ç©¶ä»»åŠ¡'
  }
  return textMap[type] || 'å…¶ä»–'
}

/**
 * è·å–ä¼˜å…ˆçº§é¢œè‰²
 */
const getPriorityColor = (priority) => {
  const colorMap = {
    high: 'red',
    medium: 'orange',
    low: 'green'
  }
  return colorMap[priority] || 'default'
}

/**
 * è·å–ä¼˜å…ˆçº§æ–‡æœ¬
 */
const getPriorityText = (priority) => {
  const textMap = {
    high: 'é«˜',
    medium: 'ä¸­',
    low: 'ä½'
  }
  return textMap[priority] || 'ä¸­'
}

/**
 * è·å–æŠ€æœ¯éš¾åº¦é¢œè‰²
 */
const getDifficultyColor = (difficulty) => {
  const colorMap = {
    high: 'red',
    medium: 'orange',
    low: 'green'
  }
  return colorMap[difficulty] || 'default'
}

/**
 * è·å–æŠ€æœ¯éš¾åº¦æ–‡æœ¬
 */
const getDifficultyText = (difficulty) => {
  const textMap = {
    high: 'é«˜',
    medium: 'ä¸­',
    low: 'ä½'
  }
  return textMap[difficulty] || 'ä¸­'
}

/**
 * è·å–è¿›åº¦çŠ¶æ€
 */
const getProgressStatus = (progress) => {
  if (progress >= 100) return 'success'
  if (progress >= 80) return 'active'
  if (progress > 0) return 'normal'
  return 'exception'
}

/**
 * æ ¼å¼åŒ–æ—¶é—´
 */
const formatTime = (timeString) => {
  if (!timeString) return ''
  
  try {
    const date = new Date(timeString)
    return date.toLocaleString('zh-CN')
  } catch (error) {
    return timeString
  }
}

/**
 * è·å–åç»­ä»»åŠ¡
 */
const getFollowingTasks = (taskId) => {
  return props.tasks
    .filter(task => task.dependencies && task.dependencies.includes(taskId))
    .map(task => task.id)
}

/**
 * é«˜äº®ä»»åŠ¡
 */
const highlightTask = (taskId) => {
  // è¿™é‡Œå¯ä»¥å®ç°é«˜äº®æ˜¾ç¤ºæŒ‡å®šä»»åŠ¡çš„é€»è¾‘
  message.info(`é«˜äº®ä»»åŠ¡: ${taskId}`)
}

/**
 * ç¼–è¾‘ä»»åŠ¡
 */
const editTask = (task) => {
  emit('editTask', task)
}

/**
 * å¤åˆ¶ä»»åŠ¡
 */
const duplicateTask = (task) => {
  const duplicated = {
    ...task,
    id: `${task.id}_copy_${Date.now()}`,
    name: `${task.name} (å‰¯æœ¬)`
  }
  
  // è¿™é‡Œåº”è¯¥è°ƒç”¨çˆ¶ç»„ä»¶çš„æ–¹æ³•æ¥æ·»åŠ æ–°ä»»åŠ¡
  message.success(`ä»»åŠ¡ "${task.name}" å·²å¤åˆ¶`)
}

/**
 * ç§»åŠ¨ä»»åŠ¡
 */
const moveTask = (task, direction) => {
  message.info(`${direction === 'up' ? 'ä¸Šç§»' : 'ä¸‹ç§»'}ä»»åŠ¡: ${task.name}`)
}

/**
 * åˆ é™¤ä»»åŠ¡
 */
const deleteTask = (task) => {
  // è¿™é‡Œåº”è¯¥è°ƒç”¨çˆ¶ç»„ä»¶çš„æ–¹æ³•æ¥åˆ é™¤ä»»åŠ¡
  message.success(`ä»»åŠ¡ "${task.name}" å·²åˆ é™¤`)
}

/**
 * å¯¼å‡ºä»»åŠ¡
 */
const exportTasks = () => {
  const data = props.tasks.map(task => ({
    ID: task.id,
    åç§°: task.name,
    ç±»å‹: getTypeText(task.type),
    ä¼˜å…ˆçº§: getPriorityText(task.priority),
    å·¥æœŸ: task.estimatedDuration || 0,
    ä¾èµ–: task.dependencies ? task.dependencies.join(', ') : '',
    äº¤ä»˜ç‰©: task.deliverables ? task.deliverables.join(', ') : ''
  }))
  
  // è¿™é‡Œå¯ä»¥å®ç°å¯¼å‡ºä¸ºExcelæˆ–CSVçš„é€»è¾‘
  console.log('å¯¼å‡ºæ•°æ®:', data)
  message.success('ä»»åŠ¡æ•°æ®å·²å¯¼å‡º')
}

/**
 * ç”Ÿæˆç”˜ç‰¹å›¾
 */
const generateGantt = () => {
  message.info('æ­£åœ¨ç”Ÿæˆç”˜ç‰¹å›¾...')
}

/**
 * ä¾èµ–åˆ†æ
 */
const analyzeDepedencies = () => {
  message.info('æ­£åœ¨åˆ†æä»»åŠ¡ä¾èµ–å…³ç³»...')
}

/**
 * ä»»åŠ¡ä¼˜åŒ–
 */
const optimizeTasks = () => {
  message.info('æ­£åœ¨ä¼˜åŒ–ä»»åŠ¡å®‰æ’...')
}
</script>

<style scoped>
.task-details {
  max-height: 80vh;
  overflow-y: auto;
}

.list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #f0f0f0;
}

.list-header h3 {
  margin: 0;
  color: #333;
}

.task-items {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.task-detail-item {
  border: 1px solid #e8e8e8;
  border-radius: 8px;
  padding: 16px;
  background: #fff;
  transition: all 0.3s ease;
}

.task-detail-item:hover {
  border-color: #1890ff;
  box-shadow: 0 2px 8px rgba(24, 144, 255, 0.1);
}

.task-detail-item.priority-high {
  border-left: 4px solid #ff4d4f;
}

.task-detail-item.priority-medium {
  border-left: 4px solid #faad14;
}

.task-detail-item.priority-low {
  border-left: 4px solid #52c41a;
}

.task-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.task-title-section {
  flex: 1;
}

.task-name {
  margin: 0 0 8px 0;
  color: #333;
  display: flex;
  align-items: center;
  gap: 8px;
}

.task-index {
  color: #1890ff;
  font-weight: 600;
  min-width: 24px;
}

.task-meta {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.task-description {
  margin-bottom: 16px;
}

.task-description p {
  margin: 0;
  color: #666;
  line-height: 1.5;
}

.task-info-grid {
  margin-bottom: 16px;
}

.info-section h5 {
  margin: 0 0 12px 0;
  color: #333;
  font-size: 14px;
}

.dependency-info,
.special-attributes {
  font-size: 13px;
}

.dependency-item,
.attribute-item {
  margin-bottom: 8px;
}

.dependency-tags,
.tech-tags {
  margin-top: 4px;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.no-dependency {
  color: #999;
  font-style: italic;
}

.deliverables-section,
.criteria-section,
.progress-section {
  margin-bottom: 12px;
}

.deliverables-section h5,
.criteria-section h5,
.progress-section h5 {
  margin: 0 0 8px 0;
  color: #333;
  font-size: 14px;
}

.criteria-list {
  margin: 0;
  padding-left: 16px;
  font-size: 13px;
}

.criteria-list li {
  margin: 4px 0;
  color: #666;
}

.task-statistics,
.action-area {
  margin-top: 24px;
}

.empty-state {
  text-align: center;
  padding: 60px 0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .list-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .task-header {
    flex-direction: column;
    gap: 12px;
  }
  
  .task-info-grid .ant-col {
    margin-bottom: 16px;
  }
}
</style>
