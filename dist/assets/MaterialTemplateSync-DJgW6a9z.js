import{c as $,r as ae,k as l,_ as oe,a as B,o as se,as as re,l as ie,b as y,d as h,p as F,e as f,j as w,m as S,F as ne,t as I,w as _,g as U,v as le,x as de,L as ce,h as ue,i as v,W as pe,n as me,f as L,at as ge,J as fe,H as ve,G as he}from"./index-XOIS1SV9.js";import{U as _e}from"./UploadOutlined-BeZhUyI8.js";const r=ae({configs:{apply:[],opening:[],midterm:[],acceptance:[]},loading:!1,lastUpdateTime:null,version:"1.0.0"}),ye={apply:"立项申请",opening:"项目开题",midterm:"项目中期",acceptance:"项目验收"},b=()=>({apply:[{id:1,categoryName:"项目申请书",isRequired:!0,templateFileName:"项目申请书模板.docx",templateFilePath:"/templates/apply/project_application.docx",sortOrder:1,description:"详细的项目申请信息，包含项目背景、目标、实施方案等",businessType:"apply",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:2,categoryName:"可行性研究报告",isRequired:!0,templateFileName:"可行性研究报告模板.docx",templateFilePath:"/templates/apply/feasibility_study.docx",sortOrder:2,description:"项目技术可行性、经济可行性分析报告",businessType:"apply",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],opening:[{id:11,categoryName:"开题报告",isRequired:!0,templateFileName:"开题报告模板.docx",templateFilePath:"/templates/opening/opening_report.docx",sortOrder:1,description:"项目开题报告，说明研究方案和计划",businessType:"opening",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],midterm:[{id:21,categoryName:"中期报告",isRequired:!0,templateFileName:"中期报告模板.docx",templateFilePath:"/templates/midterm/midterm_report.docx",sortOrder:1,description:"项目中期进展报告",businessType:"midterm",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],acceptance:[{id:31,categoryName:"验收报告",isRequired:!0,templateFileName:"验收报告模板.docx",templateFilePath:"/templates/acceptance/acceptance_report.docx",sortOrder:1,description:"项目验收报告",businessType:"acceptance",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}]}),q=new Map,j=e=>r.configs[e]||[],Se=$(()=>{const e={};return Object.keys(r.configs).forEach(o=>{const s=r.configs[o]||[];e[o]={total:s.length,required:s.filter(i=>i.isRequired).length,optional:s.filter(i=>!i.isRequired).length}}),e}),V=()=>{try{const e=localStorage.getItem("materialTemplateConfigs");if(e){const o=JSON.parse(e);return r.configs=o.configs||{},r.version=o.version||"1.0.0",r.lastUpdateTime=o.lastUpdateTime,!0}}catch(e){console.error("加载配置失败:",e)}return!1},x=()=>{try{const e={configs:r.configs,version:r.version,lastUpdateTime:r.lastUpdateTime};return localStorage.setItem("materialTemplateConfigs",JSON.stringify(e)),!0}catch(e){return console.error("保存配置失败:",e),!1}},we=async()=>{r.loading=!0;try{V()||(r.configs=b(),r.lastUpdateTime=new Date().toISOString(),x()),l.success("配置加载成功")}catch(e){console.error("初始化配置失败:",e),l.error("配置加载失败")}finally{r.loading=!1}},Ce=async(e,o)=>{try{const s={...o,id:Date.now(),businessType:e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return r.configs[e]||(r.configs[e]=[]),r.configs[e].push(s),r.lastUpdateTime=new Date().toISOString(),x(),C(e),l.success("添加配置成功"),s}catch(s){throw console.error("添加配置失败:",s),l.error("添加配置失败"),s}},xe=async(e,o,s)=>{try{const i=r.configs[e]||[],u=i.findIndex(D=>D.id===o);if(u===-1)throw new Error("配置项不存在");const k={...i[u],...s,updatedAt:new Date().toISOString()};return r.configs[e][u]=k,r.lastUpdateTime=new Date().toISOString(),x(),C(e),l.success("更新配置成功"),k}catch(i){throw console.error("更新配置失败:",i),l.error("更新配置失败"),i}},Oe=async(e,o)=>{try{const i=(r.configs[e]||[]).findIndex(u=>u.id===o);if(i===-1)throw new Error("配置项不存在");return r.configs[e].splice(i,1),r.lastUpdateTime=new Date().toISOString(),x(),C(e),l.success("删除配置成功"),!0}catch(s){throw console.error("删除配置失败:",s),l.error("删除配置失败"),s}},Ue=async(e,o)=>{try{return r.configs[e]=o.map(s=>({...s,businessType:e,updatedAt:new Date().toISOString()})),r.lastUpdateTime=new Date().toISOString(),x(),C(e),l.success("批量更新配置成功"),!0}catch(s){throw console.error("批量更新配置失败:",s),l.error("批量更新配置失败"),s}},qe=async e=>{try{const o=b();return e?r.configs[e]=o[e]||[]:r.configs=o,r.lastUpdateTime=new Date().toISOString(),x(),e?C(e):Object.keys(o).forEach(s=>{C(s)}),l.success("重置配置成功"),!0}catch(o){throw console.error("重置配置失败:",o),l.error("重置配置失败"),o}},C=e=>{const o=q.get(e);if(o&&o.size>0){const s=j(e);o.forEach(i=>{try{i(s,e)}catch(u){console.error("页面更新回调执行失败:",u)}})}},De=(e,o)=>(q.has(e)||q.set(e,new Set),q.get(e).add(o),()=>{const s=q.get(e);s&&(s.delete(o),s.size===0&&q.delete(e))}),E={state:r,businessTypeMap:ye,getConfigsStats:Se,initConfigs:we,getConfigsByBusinessType:j,addConfig:Ce,updateConfig:xe,deleteConfig:Oe,batchUpdateConfigs:Ue,resetToDefault:qe,registerPageUpdateListener:De,notifyBusinessPageUpdate:C,saveConfigsToStorage:x,loadConfigsFromStorage:V},Fe={class:"material-template-sync"},Ie={class:"material-submit-section"},ke={class:"section-header"},Re={class:"header-actions"},Ne={key:0,class:"material-list"},Ee={class:"material-info"},Ae={class:"material-title"},Te={class:"category-name"},ze={key:0,class:"material-desc"},Be={key:1,class:"template-download"},Le={class:"upload-area"},Me={key:0,class:"uploaded-file"},Pe={class:"file-info"},$e={class:"file-name"},be={key:1,class:"empty-state"},je={key:2,class:"submit-summary"},Ve={__name:"MaterialTemplateSync",props:{businessType:{type:String,required:!0,validator:e=>["apply","opening","midterm","acceptance"].includes(e)},autoLoad:{type:Boolean,default:!0},showActions:{type:Boolean,default:!0}},emits:["files-change","validation-change","config-update"],setup(e,{expose:o,emit:s}){const i=e,u=s,k=ue(),D=B(!1),m=B([]),g=B(new Map),{businessTypeMap:J}=E,O=$(()=>m.value.filter(a=>a.isRequired).every(a=>g.value.has(a.id))),G=()=>{const t=m.value.length,a=m.value.filter(p=>p.isRequired).length,d=g.value.size,c=m.value.filter(p=>p.isRequired).filter(p=>g.value.has(p.id)).length;return O.value?`已上传 ${d}/${t} 个文件，所有必传材料已完成`:`已上传 ${c}/${a} 个必传材料，还需上传 ${a-c} 个必传文件`},A=t=>g.value.get(t),M=async()=>{await R()},R=async()=>{D.value=!0;try{const t=E.getConfigsByBusinessType(i.businessType);m.value=t.sort((a,d)=>(a.sortOrder||0)-(d.sortOrder||0)),u("config-update",t)}catch(t){console.error("加载配置失败:",t),l.error("加载配置失败")}finally{D.value=!1}},H=(t,a)=>{if(t.size>52428800)return l.error("文件大小不能超过50MB"),!1;if(a.templateFileName){const c=a.templateFileName.split(".").pop().toLowerCase(),p=t.name.split(".").pop().toLowerCase(),N={docx:["docx","doc","pdf"],doc:["docx","doc","pdf"],xlsx:["xlsx","xls"],xls:["xlsx","xls"],pdf:["pdf","docx","doc"]}[c]||[c];if(!N.includes(p))return l.error(`请上传 ${N.join("、")} 格式的文件`),!1}return g.value.set(a.id,t),u("files-change",{configId:a.id,file:t,action:"add"}),u("validation-change",{allRequiredUploaded:O.value,uploadedCount:g.value.size,totalCount:m.value.length}),l.success(`文件 "${t.name}" 已选择`),!1},W=t=>{const a=g.value.get(t);a&&(g.value.delete(t),u("files-change",{configId:t,file:a,action:"remove"}),u("validation-change",{allRequiredUploaded:O.value,uploadedCount:g.value.size,totalCount:m.value.length}),l.success("文件已移除"))},K=t=>{l.info(`正在下载模板：${t.templateFileName}`)},Q=()=>{k.push("/settings/material-template")},X=()=>{const t=[];return g.value.forEach((a,d)=>{const c=m.value.find(p=>p.id===d);t.push({configId:d,config:c,file:a})}),t},Y=()=>({valid:O.value,missingFiles:m.value.filter(t=>t.isRequired&&!g.value.has(t.id)).map(t=>t.categoryName)}),Z=()=>{g.value.clear(),u("validation-change",{allRequiredUploaded:!1,uploadedCount:0,totalCount:m.value.length}),l.success("已清空所有文件")};let T=null;const ee=()=>{T=E.registerPageUpdateListener(i.businessType,t=>{m.value=t.sort((c,p)=>(c.sortOrder||0)-(p.sortOrder||0));const a=new Set(t.map(c=>c.id)),d=[];g.value.forEach((c,p)=>{a.has(p)||d.push(p)}),d.forEach(c=>{g.value.delete(c)}),u("config-update",t),d.length>0&&u("validation-change",{allRequiredUploaded:O.value,uploadedCount:g.value.size,totalCount:m.value.length})})};return se(async()=>{i.autoLoad&&(await E.initConfigs(),await R()),ee()}),re(()=>{T&&T()}),ie(()=>i.businessType,async()=>{i.autoLoad&&await R()},{immediate:!1}),o({refreshConfigs:M,getAllUploadedFiles:X,validateRequiredFiles:Y,clearAllFiles:Z,loadConfigs:R}),(t,a)=>{const d=U("a-button"),c=U("a-tag"),p=U("a-tooltip"),P=U("a-upload"),N=U("a-empty"),te=U("a-alert");return v(),y("div",Fe,[h("div",Ie,[h("div",ke,[h("h4",null,[f(S(ne)),w(" "+I(S(J)[e.businessType]||"材料")+"提交 ",1)]),h("div",Re,[f(d,{type:"link",size:"small",onClick:M,loading:D.value},{default:_(()=>[f(S(pe)),a[0]||(a[0]=w(" 刷新配置 "))]),_:1,__:[0]},8,["loading"])])]),m.value.length>0?(v(),y("div",Ne,[(v(!0),y(le,null,de(m.value,n=>(v(),y("div",{key:n.id,class:me(["material-item",{required:n.isRequired}])},[h("div",Ee,[h("div",Ae,[h("span",Te,[w(I(n.categoryName)+" ",1),n.isRequired?(v(),L(c,{key:0,color:"red",size:"small"},{default:_(()=>a[1]||(a[1]=[w("必传")])),_:1,__:[1]})):(v(),L(c,{key:1,color:"blue",size:"small"},{default:_(()=>a[2]||(a[2]=[w("选传")])),_:1,__:[2]}))]),n.description?(v(),L(p,{key:0,title:n.description},{default:_(()=>[f(S(ge),{class:"info-icon"})]),_:2},1032,["title"])):F("",!0)]),n.description?(v(),y("div",ze,I(n.description),1)):F("",!0),n.templateFileName?(v(),y("div",Be,[f(d,{type:"link",size:"small",onClick:z=>K(n),class:"template-link"},{default:_(()=>[f(S(fe)),w(" 下载模板："+I(n.templateFileName),1)]),_:2},1032,["onClick"])])):F("",!0)]),h("div",Le,[f(P,{name:`file_${n.id}`,multiple:!1,"show-upload-list":!1,"before-upload":z=>H(z,n),class:"material-upload"},{default:_(()=>[f(d,{type:"primary",size:n.isRequired?"default":"small",danger:n.isRequired&&!A(n.id)},{default:_(()=>[f(S(_e)),a[3]||(a[3]=w(" 选择文件 "))]),_:2,__:[3]},1032,["size","danger"])]),_:2},1032,["name","before-upload"]),A(n.id)?(v(),y("div",Me,[h("div",Pe,[f(S(ve)),h("span",$e,I(A(n.id).name),1),f(d,{type:"link",size:"small",danger:"",onClick:z=>W(n.id)},{default:_(()=>[f(S(he))]),_:2},1032,["onClick"])])])):F("",!0)])],2))),128))])):(v(),y("div",be,[f(N,{image:S(ce).PRESENTED_IMAGE_SIMPLE,description:"暂无配置的材料类目"},{default:_(()=>[f(d,{type:"primary",onClick:Q},{default:_(()=>a[4]||(a[4]=[w(" 前往配置 ")])),_:1,__:[4]})]),_:1},8,["image"])])),m.value.length>0?(v(),y("div",je,[f(te,{type:O.value?"success":"warning",message:G(),"show-icon":""},null,8,["type","message"])])):F("",!0)])])}}},He=oe(Ve,[["__scopeId","data-v-667164fa"]]);export{He as M,E as m};
