# ⚙️ 节点管理页面设计文档 v1.0

## 📄 页面基础信息

- **页面名称**: 节点管理计划
- **路由地址**: `/implementation/nodes`
- **组件路径**: `src/views/implementation/nodes/index.vue`
- **设计版本**: v1.0
- **更新时间**: 2025-01-17

## 🎨 UI布局草图

### 整体页面布局结构

```
┌─────────────────────────────────────────────────────────────────┐
│                    ⚙️ 节点管理计划页面容器                       │
│                   (全屏宽度，背景 #f5f7fa)                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                📊 页面头部区域                          │   │
│  │  ┌─────────────────────┐  ┌─────────────────────────┐  │   │
│  │  │ ⚙️ 节点管理计划      │  │ [选择项目_______▼]      │  │   │
│  │  │ 配置项目实施节点，    │  │ [💾保存配置] [🚀发布]   │  │   │
│  │  │ 支持拖拽排序、属性    │  │                        │  │   │
│  │  │ 编辑、依赖关系与流程  │  │                        │  │   │
│  │  │ 预览                │  │                        │  │   │
│  │  └─────────────────────┘  └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                📚 节点模板库区域                         │   │
│  │                                                         │   │
│  │  模板选择: [选择模板___________________▼] [管理模板]     │   │
│  │                                                         │   │
│  │  💡 快速应用常用项目节点模板，提升配置效率               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                🔧 节点配置区域（可拖拽）                 │   │
│  │                                                         │   │
│  │  ☰ [节点1___] [30%] [合同签订后7日___] [2024-01-22] [编辑] │   │
│  │  ☰ [节点2___] [40%] [项目进度过半____] [2024-06-15] [编辑] │   │
│  │  ☰ [节点3___] [30%] [项目验收合格____] [2024-12-01] [编辑] │   │
│  │                                                         │   │
│  │  [+ 添加节点]                                          │   │
│  │                                                         │   │
│  │  节点属性说明:                                          │   │
│  │  • 拖拽☰调整节点顺序  • 设置付款比例  • 配置触发条件    │   │
│  │  • 设置截止日期      • 添加附件文档  • 设置依赖关系    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                📊 流程图预览区域                         │   │
│  │                                                         │   │
│  │           🔄 流程图预览功能开发中...                     │   │
│  │                                                         │   │
│  │  ┌─────┐    ┌─────┐    ┌─────┐                         │   │
│  │  │节点1│───→│节点2│───→│节点3│                         │   │
│  │  │30% │    │40% │    │30% │                         │   │
│  │  └─────┘    └─────┘    └─────┘                         │   │
│  │                                                         │   │
│  │  [📊 查看详细流程图] [🖨️ 导出流程图]                    │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 节点配置详细设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    🔧 节点配置区域（可拖拽）                     │
│                                                                 │
│  节点配置列表                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ☰ │ 节点名称    │比例│ 触发条件      │截止日期│依赖│附件│操作│   │
│  ├───┼──────────┼──┼─────────┼──────┼──┼──┼──┤   │
│  │ ☰ │[首付款___] │30│[合同签订后7日]│01-22 │无│📎│❌│   │
│  │   │            │% │              │     │  │  │  │   │
│  ├───┼──────────┼──┼─────────┼──────┼──┼──┼──┤   │
│  │ ☰ │[中期款___] │40│[项目进度过半_]│06-15 │↑│📎│❌│   │
│  │   │            │% │              │     │  │  │  │   │
│  ├───┼──────────┼──┼─────────┼──────┼──┼──┼──┤   │
│  │ ☰ │[尾款_____] │30│[项目验收合格_]│12-01 │↑│📎│❌│   │
│  │   │            │% │              │     │  │  │  │   │
│  └───┴──────────┴──┴─────────┴──────┴──┴──┴──┘   │
│                                                         │   │
│  操作说明                                               │   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • ☰ 拖拽图标：上下拖动调整节点执行顺序              │   │
│  │ • 比例设置：付款金额占总预算的百分比                │   │
│  │ • 依赖关系：↑表示依赖上一节点，可选择具体依赖      │   │
│  │ • 📎 附件：上传节点相关文档，最多3个文件           │   │
│  │ • ❌ 删除：移除当前节点配置                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                         │   │
│  节点验证提示                                           │   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ✅ 付款比例总和: 100% (正确)                       │   │
│  │ ⚠️ 节点2依赖关系可能存在循环依赖                   │   │
│  │ ❌ 节点3截止日期早于节点2，请检查时间设置           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                         │   │
│  快速操作                                               │   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [+ 添加节点] [📋 从合同导入] [🔄 重置配置]          │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 节点编辑弹窗详细设计

```
┌─────────────────────────────────────────────────────┐
│  🔧 编辑节点配置                              ✖️   │
├─────────────────────────────────────────────────────┤
│                                                     │
│  基础信息                                           │
│  ┌─────────────────────────────────────────────┐   │
│  │ 节点名称: [中期款_____________________]     │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────┐ ┌─────────────────────────┐   │
│  │ 付款比例: [40]% │ │ 付款金额: [80] 万元      │   │
│  └─────────────────┘ └─────────────────────────┘   │
│                                                     │
│  触发条件                                           │
│  ┌─────────────────────────────────────────────┐   │
│  │ 条件类型: [进度条件_______________▼]        │   │
│  │ • 进度条件  • 时间条件  • 文档条件          │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ 具体条件: [项目进度达到50%_______________] │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  时间设置                                           │
│  ┌─────────────────┐ ┌─────────────────────────┐   │
│  │ 计划日期: [____] │ │ 截止日期: [____________] │   │
│  │   📅 2024-06-15 │ │   📅 2024-06-30        │   │
│  └─────────────────┘ └─────────────────────────┘   │
│                                                     │
│  依赖关系                                           │
│  ┌─────────────────────────────────────────────┐   │
│  │ 前置节点: [首付款_________________▼]        │   │
│  │ 依赖类型: [完成后触发_____________▼]        │   │
│  │ • 完成后触发  • 同时进行  • 条件触发        │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  附件文档                                           │
│  ┌─────────────────────────────────────────────┐   │
│  │ [📎 上传附件] 最多3个文件，单个≤10MB         │   │
│  │                                             │   │
│  │ 📄 中期验收标准.docx        [📥] [🗑️]      │   │
│  │ 📄 进度报告模板.xlsx        [📥] [🗑️]      │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  数据类型                                           │
│  ┌─────────────────────────────────────────────┐   │
│  │ 节点数据类型: [付款节点_____________▼]      │   │
│  │ • 付款节点  • 验收节点  • 审批节点          │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│               ┌────┐ ┌────┐                        │
│               │取消│ │保存│                        │
│               └────┘ └────┘                        │
└─────────────────────────────────────────────────────┘
```

### 流程图预览详细设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    📊 流程图预览区域                             │
│                                                                 │
│  流程图显示                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │    开始                                                 │   │
│  │     ↓                                                   │   │
│  │  ┌─────────┐                                           │   │
│  │  │ 首付款   │  30% | 合同签订后7日内                   │   │
│  │  │ 节点1    │  📅 2024-01-22                           │   │
│  │  └─────────┘                                           │   │
│  │     ↓                                                   │   │
│  │  ┌─────────┐                                           │   │
│  │  │ 中期款   │  40% | 项目进度达到50%                   │   │
│  │  │ 节点2    │  📅 2024-06-15                           │   │
│  │  └─────────┘                                           │   │
│  │     ↓                                                   │   │
│  │  ┌─────────┐                                           │   │
│  │  │ 尾款     │  30% | 项目验收合格                      │   │
│  │  │ 节点3    │  📅 2024-12-01                           │   │
│  │  └─────────┘                                           │   │
│  │     ↓                                                   │   │
│  │    完成                                                 │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  流程统计信息                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 📊 节点总数: 3个                                       │   │
│  │ 💰 总预算: 200万元                                     │   │
│  │ ⏱️ 预计周期: 11个月                                     │   │
│  │ 🔗 依赖关系: 3条                                       │   │
│  │ ⚠️ 风险节点: 1个 (中期款依赖项目进度)                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  操作按钮                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ [📊 详细甘特图] [🖨️ 导出流程图] [📋 生成报告]          │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 📐 设计规格

### 🌈 色彩方案
- **页面背景**: `#f5f7fa` (浅灰蓝)
- **卡片背景**: `#ffffff` (纯白)
- **主色调**: `#234fa2` (深蓝色)
- **拖拽区域**: `#fafafa` (浅灰背景) + 虚线边框
- **节点卡片**: `#fafafa` (浅灰背景)
- **成功状态**: `#52c41a` (绿色)
- **警告状态**: `#faad14` (橙色)
- **错误状态**: `#ff4d4f` (红色)

### 📏 尺寸规格
- **页面内边距**: 24px
- **卡片圆角**: 12px
- **节点配置项**: 高度 56px，内边距 12px
- **拖拽手柄**: 宽度 20px
- **输入框间距**: 8px
- **按钮高度**: 32px

### 📝 字体规格
- **页面标题**: 24px, font-weight: bold
- **页面描述**: 14px, color: #64748b
- **卡片标题**: 18px, font-weight: 600
- **节点配置项**: 14px
- **提示信息**: 12px
- **按钮文字**: 14px

### 🎨 拖拽样式设计
- **拖拽手柄**: 三条横线图标，灰色，悬停时变深
- **拖拽状态**: 半透明效果，阴影增强
- **放置提示**: 蓝色虚线框，动画效果
- **排序指示**: 上下箭头提示可拖拽方向

## ⚡ 交互逻辑

### 🔄 页面内交互

1. **项目选择交互**
   - 下拉选择当前配置的项目
   - 切换项目时加载对应节点配置
   - 未选择项目时禁用配置功能
   - 项目信息验证和提示

2. **拖拽排序交互**
   - 点击拖拽手柄开始拖拽
   - 拖拽过程中实时预览位置
   - 放置时更新节点顺序
   - 拖拽完成后自动保存

3. **节点配置交互**
   - 内联编辑节点基本信息
   - 实时验证付款比例总和
   - 依赖关系选择和验证
   - 附件上传和管理

### 🚀 模板管理交互

1. **模板应用功能**
   - 下拉选择常用模板
   - 一键应用模板配置
   - 应用前确认替换提示
   - 模板自定义和保存

2. **模板库管理**
   - 跳转到模板管理页面
   - 创建自定义模板
   - 编辑和删除模板
   - 模板分类和搜索

### 📊 配置验证功能

1. **数据验证规则**
   - 付款比例总和必须=100%
   - 时间逻辑合理性检查
   - 依赖关系循环检测
   - 必填字段完整性验证

2. **实时提示反馈**
   - 验证结果实时显示
   - 错误项目高亮标识
   - 修复建议提示
   - 验证通过状态确认

## 🚀 页面间跳转

### 跳转路径设计

1. **模板管理跳转**
   - 跳转到模板管理页面：`/implementation/template`
   - 保存当前配置为模板
   - 返回时应用选中模板

2. **合同导入跳转**
   - 来源于合同管理页面：`source=contract`
   - 接收合同解析的节点数据
   - 合并现有配置和新数据

3. **实施流程发布**
   - 配置完成后发布到实施流程
   - 更新项目状态为"已配置节点"
   - 生成流程执行计划

### 数据传递机制
- 通过 `query` 参数接收项目ID
- 通过 `route.query.nodes` 接收节点数据
- 通过 `store` 保存配置状态
- 通过 `localStorage` 缓存编辑状态

## 📱 响应式设计

### 大屏设备 (≥1200px)
- 节点配置表格完整显示
- 流程图预览并列显示
- 所有操作按钮展开

### 中屏设备 (768px - 1199px)
- 节点配置部分列隐藏
- 流程图预览折叠显示
- 操作按钮部分收起

### 小屏设备 (≤767px)
- 节点配置改为卡片形式
- 流程图预览简化显示
- 拖拽功能保持可用

## 🛠️ 技术实现

### 核心技术栈
- **Vue 3** + Composition API
- **Ant Design Vue** 组件库
- **Vue Draggable** 拖拽排序
- **Day.js** 日期处理
- **Pinia** 状态管理

### 组件架构
1. **主页面** - 布局和数据管理
2. **拖拽列表组件** - 节点排序功能
3. **节点编辑组件** - 内联和弹窗编辑
4. **流程预览组件** - 流程图展示

### 关键功能实现

1. **拖拽排序功能**
```javascript
// 使用 Vue Draggable 实现拖拽排序
import draggable from 'vuedraggable'

const nodes = ref([
  { id: 'N1', name: '首付款', percent: 30, order: 1 },
  { id: 'N2', name: '中期款', percent: 40, order: 2 },
  { id: 'N3', name: '尾款', percent: 30, order: 3 }
])

// 拖拽完成后更新排序
const onDragEnd = () => {
  nodes.value.forEach((node, index) => {
    node.order = index + 1
  })
  saveConfiguration()
}
```

2. **配置验证功能**
```javascript
// 实时验证配置数据
const validateConfiguration = computed(() => {
  const totalPercent = nodes.value.reduce((sum, node) => sum + node.percent, 0)
  const errors = []
  
  // 验证付款比例
  if (totalPercent !== 100) {
    errors.push({
      type: 'error',
      message: `付款比例总和为${totalPercent}%，应为100%`
    })
  }
  
  // 验证依赖关系
  const hasCircularDependency = checkCircularDependency(nodes.value)
  if (hasCircularDependency) {
    errors.push({
      type: 'warning',
      message: '检测到可能的循环依赖关系'
    })
  }
  
  return errors
})
```

3. **模板应用功能**
```javascript
// 应用模板配置
const applyTemplate = (templateId) => {
  const template = nodeTemplateStore.getTemplate(templateId)
  if (!template) return
  
  Modal.confirm({
    title: '应用模板配置',
    content: '应用模板将替换当前配置，是否继续？',
    onOk: () => {
      nodes.value = template.nodes.map(node => ({
        ...node,
        id: generateUniqueId(),
        projectId: selectedProjectId.value
      }))
      message.success('模板应用成功')
    }
  })
}
```

### 数据模型设计

```javascript
// 节点配置数据模型
const nodeConfiguration = {
  id: 'N001',                        // 节点ID
  name: '首付款',                    // 节点名称
  percent: 30,                       // 付款比例
  condition: '合同签订后7日内',       // 触发条件
  conditionType: 'time',             // 条件类型
  deadline: '2024-01-22',            // 截止日期
  dependency: null,                  // 依赖节点ID
  dependencyType: 'after',           // 依赖类型
  attachments: [],                   // 附件列表
  dataType: 'payment',               // 节点数据类型
  order: 1,                          // 排序序号
  riskLevel: 'low',                  // 风险等级
  description: '项目启动付款'        // 节点描述
}
```

## 🎯 用户体验亮点

1. **直观的拖拽操作**
   - 可视化拖拽排序
   - 实时预览效果
   - 流畅的动画反馈

2. **智能的配置验证**
   - 实时数据验证
   - 智能错误提示
   - 修复建议指导

3. **高效的模板复用**
   - 快速应用常用配置
   - 自定义模板保存
   - 模板库统一管理

4. **完整的流程预览**
   - 可视化流程图展示
   - 关键信息统计
   - 多格式导出支持

## 📋 待优化项

1. **拖拽体验增强**
   - 增加拖拽动画效果
   - 支持批量移动操作
   - 键盘快捷键支持

2. **流程图功能完善**
   - 集成专业流程图组件
   - 支持复杂依赖关系显示
   - 甘特图时间线展示

3. **智能推荐功能**
   - 基于历史数据推荐配置
   - 风险预警和建议
   - 最佳实践模板推荐

4. **协作功能支持**
   - 多人同时编辑
   - 变更历史记录
   - 审批工作流集成

## 🔗 关联模块说明

### 上游数据来源
- **合同管理**: 接收解析的付款条款
- **模板库**: 获取预设节点模板
- **项目信息**: 获取项目基础数据

### 下游数据输出
- **付款管理**: 提供付款节点计划
- **进度管理**: 提供项目里程碑
- **验收管理**: 提供验收节点配置

### 状态同步
- **实施中心**: 更新项目配置状态
- **项目进度**: 同步节点执行状态
- **风险管理**: 识别配置风险点 